<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Reports - Food Safety Audit System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .department-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .dept-tab {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dept-tab.maintenance {
            background: #dbeafe;
            color: #1e40af;
        }

        .dept-tab.maintenance.active, .dept-tab.maintenance:hover {
            background: #2563eb;
            color: white;
        }

        .dept-tab.procurement {
            background: #ede9fe;
            color: #5b21b6;
        }

        .dept-tab.procurement.active, .dept-tab.procurement:hover {
            background: #7c3aed;
            color: white;
        }

        .dept-tab.cleaning {
            background: #d1fae5;
            color: #065f46;
        }

        .dept-tab.cleaning.active, .dept-tab.cleaning:hover {
            background: #059669;
            color: white;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .report-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .report-card-header {
            padding: 16px 20px;
            color: white;
            font-weight: 600;
        }

        .report-card-header.maintenance {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .report-card-header.procurement {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        .report-card-header.cleaning {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .report-card-header .doc-number {
            font-size: 16px;
        }

        .report-card-header .store-name {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .report-card-body {
            padding: 20px;
        }

        .report-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .report-info-row:last-child {
            border-bottom: none;
        }

        .report-info-label {
            color: #6b7280;
            font-size: 13px;
        }

        .report-info-value {
            color: #1f2937;
            font-weight: 500;
            font-size: 14px;
        }

        .priority-badges {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .priority-badge.high {
            background: #fee2e2;
            color: #991b1b;
        }

        .priority-badge.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .priority-badge.low {
            background: #d1fae5;
            color: #065f46;
        }

        .report-card-footer {
            padding: 15px 20px;
            background: #f9fafb;
            border-top: 1px solid #f3f4f6;
        }

        .view-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #374151;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 60px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            min-width: 150px;
        }

        .stat-card .label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .stat-card.high .value { color: #dc2626; }
        .stat-card.medium .value { color: #f59e0b; }
        .stat-card.low .value { color: #10b981; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Department Reports</h1>
        <div class="header-right">
            <span class="user-info" id="userInfo">Loading...</span>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="department-tabs">
            <button class="dept-tab maintenance active" onclick="loadReports('Maintenance')">
                üîß Maintenance
            </button>
            <button class="dept-tab procurement" onclick="loadReports('Procurement')">
                üì¶ Procurement
            </button>
            <button class="dept-tab cleaning" onclick="loadReports('Cleaning')">
                üßπ Cleaning
            </button>
        </div>

        <div class="stats-bar" id="statsBar">
            <!-- Stats will be populated here -->
        </div>

        <div id="reportsContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <div>Loading reports...</div>
            </div>
        </div>
    </div>

    <!-- Impersonation Panel Script -->
    <script src="/auth/scripts/impersonation-panel.js?v=9"></script>

    <script>
        let currentDepartment = 'Maintenance';
        let currentUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            loadReports('Maintenance');
            // Initialize impersonation panel for admins
            if (typeof initImpersonationPanel === 'function') {
                initImpersonationPanel();
            }
        });

        async function checkAuth() {
            try {
                const response = await fetch('/auth/session');
                const data = await response.json();
                if (data.authenticated) {
                    currentUser = data.user;
                    let roleDisplay = data.user.role;
                    if (data.impersonation && data.impersonation.active) {
                        roleDisplay = `${data.user.role} üé≠`;
                    }
                    document.getElementById('userInfo').textContent = `${data.user.name} (${roleDisplay})`;
                } else {
                    window.location.href = '/auth/login';
                }
            } catch (error) {
                window.location.href = '/auth/login';
            }
        }

        function logout() {
            window.location.href = '/auth/logout';
        }

        async function loadReports(department) {
            currentDepartment = department;
            
            // Update active tab
            document.querySelectorAll('.dept-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.classList.contains(department.toLowerCase())) {
                    tab.classList.add('active');
                }
            });

            // Show loading
            document.getElementById('reportsContainer').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading ${department} reports...</div>
                </div>
            `;

            try {
                const response = await fetch(`/api/department-reports/list/${department}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                renderStats(result.data);
                renderReports(result.data, department);
            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('reportsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ùå</div>
                        <h3>Error Loading Reports</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderStats(reports) {
            const totalItems = reports.reduce((sum, r) => sum + r.totalItems, 0);
            const highItems = reports.reduce((sum, r) => sum + r.highPriority, 0);
            const mediumItems = reports.reduce((sum, r) => sum + r.mediumPriority, 0);
            const lowItems = reports.reduce((sum, r) => sum + r.lowPriority, 0);

            document.getElementById('statsBar').innerHTML = `
                <div class="stat-card">
                    <div class="label">Total Reports</div>
                    <div class="value">${reports.length}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Items</div>
                    <div class="value">${totalItems}</div>
                </div>
                <div class="stat-card high">
                    <div class="label">High Priority</div>
                    <div class="value">${highItems}</div>
                </div>
                <div class="stat-card medium">
                    <div class="label">Medium Priority</div>
                    <div class="value">${mediumItems}</div>
                </div>
                <div class="stat-card low">
                    <div class="label">Low Priority</div>
                    <div class="value">${lowItems}</div>
                </div>
            `;
        }

        function renderReports(reports, department) {
            if (reports.length === 0) {
                document.getElementById('reportsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <h3>No Reports Found</h3>
                        <p>No ${department} department reports have been generated yet.</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="reports-grid">
                    ${reports.map(report => renderReportCard(report, department)).join('')}
                </div>
            `;

            document.getElementById('reportsContainer').innerHTML = html;
        }

        function renderReportCard(report, department) {
            const deptClass = department.toLowerCase();
            const auditDate = new Date(report.auditDate).toLocaleDateString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
            const generatedAt = new Date(report.generatedAt).toLocaleString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            return `
                <div class="report-card">
                    <div class="report-card-header ${deptClass}">
                        <div class="doc-number">${report.documentNumber}</div>
                        <div class="store-name">üìç ${report.storeName}</div>
                    </div>
                    <div class="report-card-body">
                        <div class="report-info-row">
                            <span class="report-info-label">üìÖ Audit Date</span>
                            <span class="report-info-value">${auditDate}</span>
                        </div>
                        <div class="report-info-row">
                            <span class="report-info-label">üìä Total Items</span>
                            <span class="report-info-value">${report.totalItems}</span>
                        </div>
                        <div class="report-info-row">
                            <span class="report-info-label">üë§ Generated By</span>
                            <span class="report-info-value">${report.generatedBy || '-'}</span>
                        </div>
                        <div class="report-info-row">
                            <span class="report-info-label">üïê Generated At</span>
                            <span class="report-info-value">${generatedAt}</span>
                        </div>
                        <div class="priority-badges">
                            ${report.highPriority > 0 ? `<span class="priority-badge high">üî¥ ${report.highPriority} High</span>` : ''}
                            ${report.mediumPriority > 0 ? `<span class="priority-badge medium">üü° ${report.mediumPriority} Medium</span>` : ''}
                            ${report.lowPriority > 0 ? `<span class="priority-badge low">üü¢ ${report.lowPriority} Low</span>` : ''}
                        </div>
                    </div>
                    <div class="report-card-footer">
                        <button class="view-btn" onclick="viewReport(${report.reportId})">
                            üëÅÔ∏è View Report
                        </button>
                    </div>
                </div>
            `;
        }

        async function viewReport(reportId) {
            try {
                const response = await fetch(`/api/department-reports/view/${reportId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const reportData = result.data.reportData;
                if (reportData) {
                    const html = generateDepartmentReportHTML(reportData);
                    const blob = new Blob([html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                }
            } catch (error) {
                alert('Error viewing report: ' + error.message);
            }
        }

        // Generate department report HTML (same as audit-list.html)
        function generateDepartmentReportHTML(report) {
            const deptColors = {
                'Maintenance': { bg: '#dbeafe', border: '#2563eb', text: '#1e40af', icon: 'üîß' },
                'Procurement': { bg: '#ede9fe', border: '#7c3aed', text: '#5b21b6', icon: 'üì¶' },
                'Cleaning': { bg: '#d1fae5', border: '#059669', text: '#065f46', icon: 'üßπ' }
            };
            const colors = deptColors[report.department] || deptColors['Maintenance'];
            const displayName = report.departmentDisplayName || report.department;
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            let itemsHTML = report.items.map((item, index) => {
                const pColor = priorityColors[item.priority] || priorityColors['Medium'];
                
                let picturesHTML = '';
                if (item.pictures && item.pictures.length > 0) {
                    picturesHTML = `
                        <div class="pic-container">
                            ${item.pictures.map(pic => `
                                <img class="pic-thumb" src="data:${pic.contentType};base64,${pic.base64}" alt="${pic.fileName}" />
                            `).join('')}
                        </div>
                    `;
                }
                
                return `
                    <tr id="ref-${item.referenceValue.replace(/\./g, '-')}">
                        <td class="col-ref">${item.referenceValue}</td>
                        <td class="col-item">
                            <div class="section-label">${item.section}</div>
                            <span class="item-title">${item.title}</span>
                        </td>
                        <td class="col-finding">${item.finding || '-'}</td>
                        <td class="col-action">${item.correctiveAction || '-'}</td>
                        <td class="col-priority">
                            <span class="priority-badge" style="background: ${pColor.bg}; color: ${pColor.text};">${item.priority}</span>
                        </td>
                        <td class="col-pictures">${picturesHTML || '<span class="no-pics">No pictures</span>'}</td>
                    </tr>
                `;
            }).join('');
            
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${displayName} Report - ${report.audit.documentNumber}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: ${colors.bg}; border-bottom: 4px solid ${colors.border}; padding: 30px; }
        .header h1 { color: ${colors.text}; font-size: 28px; margin-bottom: 10px; }
        .header-info { display: flex; gap: 30px; flex-wrap: wrap; margin-top: 15px; }
        .header-info-item { color: #374151; }
        .header-info-item strong { color: ${colors.text}; }
        .summary { display: flex; gap: 20px; padding: 20px 30px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .summary-item { padding: 15px 25px; background: white; border-radius: 8px; border-left: 4px solid ${colors.border}; }
        .summary-item .label { color: #6b7280; font-size: 12px; text-transform: uppercase; }
        .summary-item .value { font-size: 24px; font-weight: 700; color: ${colors.text}; }
        .content { padding: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: ${colors.bg}; color: ${colors.text}; padding: 14px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600; }
        
        /* Table cells - screen */
        td { padding: 12px; border: 1px solid #e5e7eb; vertical-align: top; word-wrap: break-word; }
        .col-ref { text-align: center; font-weight: 600; color: ${colors.text}; width: 6%; }
        .col-item { width: 18%; }
        .col-finding { width: 26%; white-space: pre-line; line-height: 1.5; }
        .col-action { width: 26%; white-space: pre-line; line-height: 1.5; }
        .col-priority { text-align: center; width: 8%; }
        .col-pictures { width: 16%; }
        .section-label { color: ${colors.text}; font-size: 11px; font-weight: 600; margin-bottom: 4px; }
        .item-title { font-size: 13px; }
        .priority-badge { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block; }
        .pic-container { display: flex; gap: 6px; flex-wrap: wrap; }
        .pic-thumb { width: 70px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #e5e7eb; }
        .no-pics { color: #9ca3af; font-size: 12px; }
        
        .footer { padding: 20px 30px; background: #f9fafb; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px; }
        
        @media print {
            @page {
                size: A4 landscape;
                margin: 5mm;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body { 
                background: white !important; 
                padding: 0 !important; 
                margin: 0 !important;
                font-size: 9px !important;
                width: 287mm !important;
            }
            
            .container { 
                box-shadow: none !important; 
                max-width: none !important;
                width: 100% !important;
            }
            
            .no-print, #imageModal { 
                display: none !important; 
            }
            
            .header {
                padding: 10px 15px;
                margin-bottom: 10px;
            }
            
            .header h1 {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .header-info {
                gap: 10px;
            }
            
            .header-info-item {
                font-size: 9px;
                padding: 4px 8px;
            }
            
            .summary {
                padding: 10px 15px;
                margin-bottom: 10px;
                gap: 15px;
            }
            
            .summary-item {
                padding: 8px 12px;
            }
            
            .summary-item .label {
                font-size: 8px;
            }
            
            .summary-item .value {
                font-size: 16px;
            }
            
            .content {
                padding: 5px !important;
                overflow: visible !important;
            }
            
            table {
                width: 1000px !important;
                table-layout: fixed !important;
                border-collapse: collapse !important;
            }
            
            col:nth-child(1) { width: 50px !important; }
            col:nth-child(2) { width: 150px !important; }
            col:nth-child(3) { width: 280px !important; }
            col:nth-child(4) { width: 280px !important; }
            col:nth-child(5) { width: 70px !important; }
            col:nth-child(6) { width: 170px !important; }
            
            th {
                padding: 5px !important;
                font-size: 9px !important;
                background: ${colors.bg} !important;
                white-space: nowrap !important;
            }
            
            td {
                padding: 5px !important;
                font-size: 9px !important;
                vertical-align: top !important;
                border: 1px solid #ccc !important;
            }
            
            .col-finding, .col-action {
                white-space: normal !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            .section-label { font-size: 8px !important; margin-bottom: 2px !important; }
            .item-title { font-size: 9px !important; }
            .priority-badge { font-size: 8px !important; padding: 2px 5px !important; }
            .no-pics { font-size: 8px !important; }
            
            /* Images in table */
            .pic-thumb {
                width: 40px !important;
                height: 30px !important;
            }
            .pic-container {
                gap: 3px !important;
            }
            
            /* Gallery sections */
            .picture-gallery, [style*="grid"] {
                grid-template-columns: repeat(6, 1fr) !important;
                gap: 5px !important;
            }
            
            .picture-gallery img, [style*="grid"] img {
                max-width: 80px !important;
                max-height: 60px !important;
            }
            
            /* Page breaks */
            .content table tr {
                page-break-inside: avoid;
            }
            
            .footer {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${colors.icon} ${displayName} Department Report</h1>
            <div class="header-info">
                <div class="header-info-item"><strong>Document:</strong> ${report.audit.documentNumber}</div>
                <div class="header-info-item"><strong>Store:</strong> ${report.audit.storeName}</div>
                <div class="header-info-item"><strong>Date:</strong> ${new Date(report.audit.auditDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</div>
                <div class="header-info-item"><strong>Cycle:</strong> ${report.audit.cycle} / ${report.audit.year}</div>
                <div class="header-info-item"><strong>Auditors:</strong> ${report.audit.auditors || '-'}</div>
            </div>
        </div>
        <div class="summary">
            <div class="summary-item">
                <div class="label">Total Items</div>
                <div class="value">${report.totalItems}</div>
            </div>
            <div class="summary-item" style="border-left-color: #ef4444;">
                <div class="label">High Priority</div>
                <div class="value" style="color: #ef4444;">${report.byPriority.high}</div>
            </div>
            <div class="summary-item" style="border-left-color: #f59e0b;">
                <div class="label">Medium Priority</div>
                <div class="value" style="color: #f59e0b;">${report.byPriority.medium}</div>
            </div>
            <div class="summary-item" style="border-left-color: #10b981;">
                <div class="label">Low Priority</div>
                <div class="value" style="color: #10b981;">${report.byPriority.low}</div>
            </div>
        </div>
        <div class="content">
            <table>
                <colgroup>
                    <col style="width: 50px;">
                    <col style="width: 150px;">
                    <col style="width: 280px;">
                    <col style="width: 280px;">
                    <col style="width: 70px;">
                    <col style="width: 170px;">
                </colgroup>
                <thead>
                    <tr>
                        <th class="col-ref">Ref #</th>
                        <th class="col-item">Item</th>
                        <th class="col-finding">Finding</th>
                        <th class="col-action">Corrective Action</th>
                        <th class="col-priority">Priority</th>
                        <th class="col-pictures">Pictures</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHTML}
                </tbody>
            </table>
        </div>
        ${generateFindingGalleryHTML(report, colors)}
        ${generateGoodGalleryHTML(report, colors)}
        ${generateCorrectiveGalleryHTML(report, colors)}
        <div class="footer">
            <button class="no-print" onclick="window.print()" style="padding: 10px 20px; background: ${colors.border}; color: white; border: none; border-radius: 6px; cursor: pointer;">üñ®Ô∏è Print Report</button>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;" onclick="this.style.display='none'">
        <span style="position: absolute; top: 20px; right: 40px; color: white; font-size: 40px; font-weight: bold; cursor: pointer;">&times;</span>
        <img id="modalImage" style="max-width: 90%; max-height: 90%; object-fit: contain;" />
    </div>

    <scr` + `ipt>
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'flex';
        }
        function scrollToRef(refId) {
            const element = document.getElementById('ref-' + refId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.backgroundColor = '#fef3c7';
                setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
            }
        }
    </scr` + `ipt>
</body>
</html>
            `;
        }

        // Generate Finding Picture Gallery HTML for department reports
        function generateFindingGalleryHTML(report, colors) {
            // Collect only finding pictures (not corrective)
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Finding type pictures
                    const findingPics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'finding'
                    );
                    
                    for (const pic of findingPics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            finding: item.finding,
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #fef3c7; border-bottom: 1px solid #fcd34d;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #dc2626; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #f5f5f5; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Finding ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
                    <h2 style="color: #92400e; margin-bottom: 10px;">üì∏ Finding Picture Gallery (${allPictures.length})</h2>
                    <p style="color: #78350f; font-size: 0.9rem; margin-bottom: 20px;">All finding pictures collected for easy reference. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }

        // Generate Good Observation Picture Gallery HTML for department reports
        function generateGoodGalleryHTML(report, colors) {
            // Collect only good observation pictures
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Good type pictures
                    const goodPics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'good'
                    );
                    
                    for (const pic of goodPics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            comment: item.comment || '',
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #a7f3d0;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #d1fae5; border-bottom: 1px solid #6ee7b7;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #059669; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #f0fdf4; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Good Observation ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #d1fae5; border: 2px solid #10b981; border-radius: 12px;">
                    <h2 style="color: #065f46; margin-bottom: 10px;">‚úÖ Good Observation Gallery (${allPictures.length})</h2>
                    <p style="color: #047857; font-size: 0.9rem; margin-bottom: 20px;">All good observation pictures collected for easy reference. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }

        // Generate Corrective Action Picture Gallery HTML for department reports
        function generateCorrectiveGalleryHTML(report, colors) {
            // Collect only corrective pictures
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Corrective type pictures
                    const correctivePics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'corrective'
                    );
                    
                    for (const pic of correctivePics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            finding: item.finding,
                            correctiveAction: item.correctiveAction,
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #93c5fd;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #dbeafe; border-bottom: 1px solid #60a5fa;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #2563eb; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #eff6ff; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Corrective Action ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 12px;">
                    <h2 style="color: #1e40af; margin-bottom: 10px;">üîß Corrective Action Gallery (${allPictures.length})</h2>
                    <p style="color: #1d4ed8; font-size: 0.9rem; margin-bottom: 20px;">All corrective action pictures showing fixes applied. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
