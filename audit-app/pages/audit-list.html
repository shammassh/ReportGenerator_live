<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>Audit List - Food Safety Audit System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1e3a5f;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .filters-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .stat-card .label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        .stat-card.completed .number { color: #10b981; }
        .stat-card.in-progress .number { color: #f59e0b; }

        /* Failing Branches Section */
        .failing-branches-section {
            background: white;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .failing-branches-header {
            padding: 16px 24px;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .failing-branches-header:hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        }

        .failing-branches-header h3 {
            color: #991b1b;
            font-size: 16px;
            margin: 0;
        }

        .toggle-icon {
            color: #991b1b;
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .failing-branches-content {
            padding: 20px;
            display: block;
        }

        .failing-branches-content.collapsed {
            display: none;
        }

        .cycle-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .cycle-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
        }

        .cycle-tab:hover {
            border-color: #ef4444;
            color: #ef4444;
        }

        .cycle-tab.active {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }

        .cycle-tab .fail-count {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 6px;
        }

        .cycle-tab.active .fail-count {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .failing-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .failing-branch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #fef2f2;
            border-radius: 10px;
            border-left: 4px solid #ef4444;
        }

        .failing-branch-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .failing-branch-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .failing-branch-doc {
            font-size: 12px;
            color: #6b7280;
        }

        .failing-branch-score {
            font-size: 18px;
            font-weight: 700;
            color: #ef4444;
        }

        .empty-state-small {
            text-align: center;
            padding: 30px;
            color: #9ca3af;
            font-size: 14px;
            grid-column: 1 / -1;
        }

        /* Score Colors */
        .score-pass { color: #10b981 !important; }
        .score-fail { color: #ef4444 !important; }
        .score-na { color: #9ca3af !important; }

        /* Card Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .audit-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .audit-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .card-header.pass {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .card-header.fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .card-header.in-progress {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .card-header.draft {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .doc-number {
            font-size: 16px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-completed {
            background: #065f46;
            color: white;
        }

        .status-in-progress {
            background: #92400e;
            color: white;
        }

        .status-draft {
            background: #4b5563;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-info-simple {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row .info-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }

        .info-row .info-value {
            font-size: 14px;
            color: #1e3a5f;
            font-weight: 600;
        }

        .info-row .info-value.store-name {
            font-size: 16px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .info-row .info-value.score-value {
            font-size: 18px;
            font-weight: 700;
        }

        .info-row.checklist-info-row {
            background: #f8fafc;
            margin: 8px -20px -4px -20px;
            padding: 10px 20px;
            border-top: 1px solid #e5e7eb;
        }

        .checklist-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .checklist-edition {
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .checklist-creation {
            background: #d1fae5;
            color: #065f46;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .checklist-revision {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .info-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-value {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .auditors-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .auditor-tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .card-footer {
            padding: 16px 20px;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #f3f4f6;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
        }

        .score-circle.pass {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .score-circle.fail {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .score-circle.na {
            background: #9ca3af;
            font-size: 20px;
        }

        .score-value.score-pass {
            color: #059669;
        }

        .score-value.score-fail {
            color: #dc2626;
        }

        .score-value.score-na {
            color: #9ca3af;
        }

        .score-label {
            font-size: 12px;
            color: #6b7280;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn.view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .action-btn.view:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .action-btn.continue {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .action-btn.continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #991b1b;
            padding: 10px 12px;
        }

        .action-btn.delete:hover {
            background: #fecaca;
        }

        .action-btn.action-plan {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .action-btn.action-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .action-btn.full-report {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
        }

        .action-btn.full-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }

        .action-btn.view-report {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }

        .action-btn.view-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }

        /* Department Reports Dropdown */
        .dept-reports-dropdown {
            position: relative;
            display: inline-block;
        }

        .action-btn.dept-reports {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .action-btn.dept-reports:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .dept-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            bottom: 100%;
            margin-bottom: 5px;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 1000;
            overflow: hidden;
        }

        .dept-dropdown-content.show {
            display: block;
        }

        .dept-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            text-decoration: none;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dept-dropdown-item:hover {
            background: #f3f4f6;
        }

        .dept-dropdown-item.maintenance {
            color: #2563eb;
        }

        .dept-dropdown-item.procurement {
            color: #7c3aed;
        }

        .dept-dropdown-item.cleaning {
            color: #059669;
        }

        /* Loading overlay */
        .report-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .report-loading-content {
            background: white;
            padding: 30px 50px;
            border-radius: 12px;
            text-align: center;
        }

        .report-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #374151;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .filters-bar {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .card-info {
                grid-template-columns: 1fr;
            }
        }

        /* Notification Status Badges */
        .notification-badges {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 12px 0;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .notification-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 6px;
        }

        .notification-badge.sent {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .notification-badge.submitted {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .notification-badge.pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .notification-badge .badge-icon {
            font-size: 14px;
        }

        .notification-badge .badge-date {
            font-weight: 600;
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            font-size: 22px;
            color: #4b5563;
            transition: all 0.2s;
        }

        .notification-bell:hover {
            color: #667eea;
            transform: scale(1.1);
        }

        .notification-bell .bell-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .notification-bell .bell-badge.hidden {
            display: none;
        }

        /* Notification Panel */
        .notification-panel {
            position: absolute;
            top: 100%;
            right: 0;
            width: 380px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .notification-panel.show {
            display: block;
        }

        .notification-panel-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-panel-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .notification-panel-header button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .notification-panel-header button:hover {
            background: rgba(255,255,255,0.3);
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #f9fafb;
        }

        .notification-item.unread {
            background: #f0f9ff;
            border-left: 3px solid #667eea;
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .notification-item-type {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .notification-item-type.announcement { background: #dbeafe; color: #1e40af; }
        .notification-item-type.reminder { background: #fef3c7; color: #92400e; }
        .notification-item-type.urgent { background: #fee2e2; color: #991b1b; }

        .notification-item-dismiss {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }

        .notification-item-dismiss:hover {
            color: #ef4444;
        }

        .notification-item-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .notification-item-message {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .notification-item-meta {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 8px;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #9ca3af;
        }

        .notification-empty-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .bell-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Audit List</h1>
        <div class="header-actions">
            <!-- Notification Bell -->
            <div class="bell-container">
                <button class="notification-bell" id="notificationBell" onclick="toggleNotificationPanel()">
                    üîî
                    <span class="bell-badge hidden" id="bellBadge">0</span>
                </button>
                <div class="notification-panel" id="notificationPanel">
                    <div class="notification-panel-header">
                        <h3>üîî Notifications</h3>
                        <button onclick="markAllAsRead()">Mark all read</button>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <div class="notification-empty">
                            <div class="notification-empty-icon">üîî</div>
                            <p>No notifications</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="broadcastBtn" class="btn btn-secondary" onclick="window.location.href='/admin/broadcast'" style="display: none;">
                <span>üì¢</span> Broadcast
            </button>
            <button id="startNewAuditBtn" class="btn btn-primary" onclick="window.location.href='/auditor/start-audit'" style="display: none;">
                <span>üöÄ</span> Start New Audit
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='/dashboard'">
                <span>üè†</span> Dashboard
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="number" id="totalAudits">0</div>
                <div class="label">Total Audits</div>
            </div>
            <div class="stat-card completed">
                <div class="number" id="completedAudits">0</div>
                <div class="label">Completed</div>
            </div>
            <div class="stat-card in-progress">
                <div class="number" id="inProgressAudits">0</div>
                <div class="label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="number" id="avgScore">-</div>
                <div class="label">Avg. Score</div>
            </div>
        </div>

        <!-- Failing Branches By Cycle -->
        <div class="failing-branches-section" id="failingBranchesSection">
            <div class="failing-branches-header" onclick="toggleFailingBranches()">
                <h3>‚ùå Failing Branches by Cycle</h3>
                <span class="toggle-icon" id="failingBranchesToggle">‚ñº</span>
            </div>
            <div class="failing-branches-content" id="failingBranchesContent">
                <div class="cycle-tabs" id="cycleTabs"></div>
                <div class="failing-list" id="failingList">
                    <div class="empty-state-small">Select a cycle to view failing branches</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="filter-group">
                <label>Status</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="">All Statuses</option>
                    <option value="Completed">Completed</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Draft">Draft</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Store</label>
                <select id="storeFilter" onchange="applyFilters()">
                    <option value="">All Stores</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Year</label>
                <select id="yearFilter" onchange="applyFilters()">
                    <option value="">All Years</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Cycle</label>
                <select id="cycleFilter" onchange="applyFilters()">
                    <option value="">All Cycles</option>
                    <option value="C1">C1 (Jan-Feb)</option>
                    <option value="C2">C2 (Mar-Apr)</option>
                    <option value="C3">C3 (May-Jun)</option>
                    <option value="C4">C4 (Jul-Aug)</option>
                    <option value="C5">C5 (Sep-Oct)</option>
                    <option value="C6">C6 (Nov-Dec)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="searchInput" placeholder="Document # or Store" oninput="applyFilters()">
            </div>
        </div>

        <!-- Cards Grid -->
        <div id="cardsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading audits...</div>
            </div>
        </div>
    </div>

    <!-- Impersonation Panel Script -->
    <script src="/auth/scripts/impersonation-panel.js?v=9"></script>

    <script>
        let allAudits = [];
        let filteredAudits = [];
        let currentUserRole = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize impersonation panel for admins
            if (typeof initImpersonationPanel === 'function') {
                initImpersonationPanel();
            }
            
            // Load notification bell unread count
            loadUnreadCount();
            
            // Check user role and show/hide Start New Audit button
            try {
                const sessionRes = await fetch('/auth/session');
                if (sessionRes.ok) {
                    const sessionData = await sessionRes.json();
                    currentUserRole = sessionData.user?.role;
                    // Only show Start New Audit for Admin, SuperAuditor, and Auditor
                    if (currentUserRole === 'Admin' || currentUserRole === 'SuperAuditor' || currentUserRole === 'Auditor') {
                        document.getElementById('startNewAuditBtn').style.display = 'flex';
                    }
                    // Only show Broadcast button for Admin and SuperAuditor
                    if (currentUserRole === 'Admin' || currentUserRole === 'SuperAuditor') {
                        document.getElementById('broadcastBtn').style.display = 'flex';
                    }
                }
            } catch (e) {
                console.error('Error checking user role:', e);
            }
            
            await loadAudits();
        });

        async function loadAudits() {
            try {
                const response = await fetch('/api/audits/list');
                
                // Handle authentication errors
                if (response.status === 401) {
                    window.location.href = '/auth/login?returnUrl=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Failed to load audits');
                }
                
                allAudits = data.audits || [];
                
                // Populate filters
                populateFilters();
                
                // Update stats
                updateStats();
                
                // Apply initial filters
                applyFilters();
                
            } catch (error) {
                console.error('Error loading audits:', error);
                document.getElementById('cardsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <h3>Error Loading Audits</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function populateFilters() {
            // Populate stores
            const stores = [...new Set(allAudits.map(a => a.StoreName).filter(Boolean))];
            const storeSelect = document.getElementById('storeFilter');
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelect.appendChild(option);
            });

            // Populate years
            const years = [...new Set(allAudits.map(a => a.AuditYear).filter(Boolean))].sort((a, b) => b - a);
            const yearSelect = document.getElementById('yearFilter');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        function updateStats() {
            const total = allAudits.length;
            const completed = allAudits.filter(a => a.Status === 'Completed').length;
            const inProgress = allAudits.filter(a => a.Status === 'In Progress').length;
            
            const completedWithScores = allAudits.filter(a => a.Status === 'Completed' && a.TotalScore !== null);
            const avgScore = completedWithScores.length > 0 
                ? Math.round(completedWithScores.reduce((sum, a) => sum + a.TotalScore, 0) / completedWithScores.length)
                : '-';

            document.getElementById('totalAudits').textContent = total;
            document.getElementById('completedAudits').textContent = completed;
            document.getElementById('inProgressAudits').textContent = inProgress;
            document.getElementById('avgScore').textContent = avgScore !== '-' ? avgScore + '%' : '-';
            
            // Update failing branches
            updateFailingBranches();
        }

        // Passing threshold (should match system setting)
        const PASSING_THRESHOLD = 83;

        function updateFailingBranches() {
            // Group failing audits by cycle and year
            const failingByCycle = {};
            
            allAudits.forEach(audit => {
                if (audit.Status === 'Completed' && audit.TotalScore !== null && audit.TotalScore < PASSING_THRESHOLD) {
                    const cycleKey = `${audit.AuditCycle || 'N/A'} ${audit.AuditYear || ''}`.trim();
                    if (!failingByCycle[cycleKey]) {
                        failingByCycle[cycleKey] = [];
                    }
                    failingByCycle[cycleKey].push(audit);
                }
            });

            // Sort cycles (most recent first)
            const sortedCycles = Object.keys(failingByCycle).sort((a, b) => {
                // Extract year and cycle for sorting
                const [cycleA, yearA] = a.split(' ');
                const [cycleB, yearB] = b.split(' ');
                if (yearA !== yearB) return (parseInt(yearB) || 0) - (parseInt(yearA) || 0);
                return cycleB.localeCompare(cycleA);
            });

            // Render cycle tabs
            const tabsHtml = sortedCycles.map((cycle, idx) => {
                const count = failingByCycle[cycle].length;
                return `<button class="cycle-tab ${idx === 0 ? 'active' : ''}" onclick="showFailingForCycle('${cycle}')">${cycle} <span class="fail-count">${count}</span></button>`;
            }).join('');

            document.getElementById('cycleTabs').innerHTML = tabsHtml || '<span class="empty-state-small">No failing audits found</span>';

            // Store for later use BEFORE showing first cycle
            window.failingByCycle = failingByCycle;

            // Show first cycle by default
            if (sortedCycles.length > 0) {
                showFailingForCycle(sortedCycles[0]);
            } else {
                document.getElementById('failingList').innerHTML = '<div class="empty-state-small">üéâ All branches passed! No failing audits.</div>';
            }
        }

        function showFailingForCycle(cycleKey) {
            // Update active tab
            document.querySelectorAll('.cycle-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.includes(cycleKey.split(' ')[0]));
            });

            const failingAudits = window.failingByCycle[cycleKey] || [];
            
            if (failingAudits.length === 0) {
                document.getElementById('failingList').innerHTML = '<div class="empty-state-small">No failing branches in this cycle</div>';
                return;
            }

            // Sort by score (lowest first)
            failingAudits.sort((a, b) => (a.TotalScore || 0) - (b.TotalScore || 0));

            const listHtml = failingAudits.map(audit => `
                <div class="failing-branch-item" onclick="window.location.href='/auditor/fill-audit?id=${audit.AuditID}&readonly=true'" style="cursor: pointer;">
                    <div class="failing-branch-info">
                        <div class="failing-branch-name">üè™ ${audit.StoreName || 'Unknown Store'}</div>
                        <div class="failing-branch-doc">${audit.DocumentNumber || '-'}</div>
                    </div>
                    <div class="failing-branch-score">${Math.round(audit.TotalScore)}%</div>
                </div>
            `).join('');

            document.getElementById('failingList').innerHTML = listHtml;
        }

        function toggleFailingBranches() {
            const content = document.getElementById('failingBranchesContent');
            const toggle = document.getElementById('failingBranchesToggle');
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const store = document.getElementById('storeFilter').value;
            const year = document.getElementById('yearFilter').value;
            const cycle = document.getElementById('cycleFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredAudits = allAudits.filter(audit => {
                if (status && audit.Status !== status) return false;
                if (store && audit.StoreName !== store) return false;
                if (year && audit.AuditYear != year) return false;
                if (cycle && audit.AuditCycle !== cycle) return false;
                if (search) {
                    const matchesDoc = audit.DocumentNumber?.toLowerCase().includes(search);
                    const matchesStore = audit.StoreName?.toLowerCase().includes(search);
                    if (!matchesDoc && !matchesStore) return false;
                }
                return true;
            });

            renderCards();
            
            // Check for published reports (for StoreManager)
            checkPublishedReports();
            
            // Load notification statuses (for Admin, Auditor, SuperAuditor)
            loadNotificationStatuses();
        }

        function renderCards() {
            if (filteredAudits.length === 0) {
                document.getElementById('cardsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <h3>No Audits Found</h3>
                        <p>No audits match your filter criteria. Try adjusting the filters or start a new audit.</p>
                    </div>
                `;
                return;
            }

            const cardsHtml = `
                <div class="cards-grid">
                    ${filteredAudits.map(audit => renderCard(audit)).join('')}
                </div>
            `;

            document.getElementById('cardsContainer').innerHTML = cardsHtml;
        }

        function renderCard(audit) {
            const statusClass = audit.Status?.toLowerCase().replace(' ', '-') || 'draft';
            const auditors = (audit.Auditors || '').split(',').filter(a => a.trim());
            const auditorName = auditors.length > 0 ? auditors[0].trim() : 'Not Assigned';
            
            // For completed audits, use pass/fail based on system setting threshold
            let headerClass = statusClass;
            const passingGrade = audit.PassingGrade || 83;
            if (audit.Status === 'Completed' && audit.TotalScore !== null) {
                headerClass = audit.TotalScore >= passingGrade ? 'pass' : 'fail';
            }
            
            const score = audit.TotalScore !== null ? Math.round(audit.TotalScore) : null;
            const scoreClass = score !== null ? (score >= passingGrade ? 'pass' : 'fail') : 'na';
            
            return `
                <div class="audit-card">
                    <div class="card-header ${headerClass}">
                        <div class="doc-number">${audit.DocumentNumber || '-'}</div>
                        <span class="status-badge status-${statusClass}">
                            ${audit.Status === 'Completed' ? '‚úì ' : audit.Status === 'In Progress' ? '‚è≥ ' : ''}${audit.Status || 'Draft'}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="card-info-simple">
                            <div class="info-row">
                                <span class="info-label">üè™ Store</span>
                                <span class="info-value store-name">${audit.StoreName || 'Unknown Store'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üîÑ Cycle</span>
                                <span class="info-value">${audit.AuditCycle || '-'} / ${audit.AuditYear || '-'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üë§ Auditor</span>
                                <span class="info-value">${auditorName}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üìä Score</span>
                                <span class="info-value score-value score-${scoreClass}">${score !== null ? score + '%' : '‚Äî'}</span>
                            </div>
                            ${audit.Status === 'Completed' && currentUserRole !== 'StoreManager' ? `
                            <div class="notification-badges" id="badges-${audit.AuditID}">
                                <div class="notification-badge pending">
                                    <span class="badge-icon">‚è≥</span>
                                    <span>Loading status...</span>
                                </div>
                            </div>
                            ` : ''}
                            <div class="info-row checklist-info-row">
                                <span class="info-label">üìã Checklist</span>
                                <span class="info-value checklist-meta">
                                    ${audit.ChecklistEdition ? '<span class="checklist-edition">Ed: ' + audit.ChecklistEdition + '</span>' : ''}
                                    ${audit.ChecklistCreationDate ? '<span class="checklist-creation">Created: ' + formatDate(audit.ChecklistCreationDate) + '</span>' : ''}
                                    ${audit.ChecklistRevisionDate ? '<span class="checklist-revision">Rev: ' + formatDate(audit.ChecklistRevisionDate) + '</span>' : ''}
                                    ${!audit.ChecklistEdition && !audit.ChecklistRevisionDate && !audit.ChecklistCreationDate ? '‚Äî' : ''}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="card-actions">
                            ${renderActions(audit)}
                        </div>
                    </div>
                </div>
            `;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        function renderScoreCircle(audit) {
            if (audit.Status !== 'Completed' || audit.TotalScore === null) {
                return '<div class="score-circle na">‚Äî</div>';
            }
            const score = Math.round(audit.TotalScore);
            const passingGrade = audit.PassingGrade || 83;
            const cssClass = score >= passingGrade ? 'pass' : 'fail';
            return `<div class="score-circle ${cssClass}">${score}%</div>`;
        }

        function renderActions(audit) {
            if (audit.Status === 'Completed') {
                // Full Report and Department Reports - hidden for StoreManager
                const fullReportHtml = (currentUserRole !== 'StoreManager') ? `
                    <button class="action-btn full-report" onclick="generateFullReport(${audit.AuditID}); event.stopPropagation();">
                        üìä Full Report
                    </button>
                ` : '';
                
                // View Published Report - for StoreManager only
                const viewReportHtml = (currentUserRole === 'StoreManager') ? `
                    <button class="action-btn view-report" id="viewReportBtn-${audit.AuditID}" onclick="viewPublishedReport(${audit.AuditID}); event.stopPropagation();" style="display:none;">
                        üìÑ View Report
                    </button>
                ` : '';
                
                const deptReportsHtml = (currentUserRole !== 'StoreManager') ? `
                    <div class="dept-reports-dropdown">
                        <button class="action-btn dept-reports" onclick="toggleDeptDropdown(${audit.AuditID}); event.stopPropagation();">
                            üìã Dept Reports ‚ñæ
                        </button>
                        <div class="dept-dropdown-content" id="dept-dropdown-${audit.AuditID}">
                            <button class="dept-dropdown-item maintenance" onclick="generateDeptReport(${audit.AuditID}, 'Maintenance'); event.stopPropagation();">
                                üîß Maintenance Report
                            </button>
                            <button class="dept-dropdown-item procurement" onclick="generateDeptReport(${audit.AuditID}, 'Procurement'); event.stopPropagation();">
                                üì¶ Procurement Report
                            </button>
                            <button class="dept-dropdown-item cleaning" onclick="generateDeptReport(${audit.AuditID}, 'Cleaning'); event.stopPropagation();">
                                üßπ Cleaning Report
                            </button>
                        </div>
                    </div>
                ` : '';
                
                // Delete button for Admin/SuperAuditor only on completed audits
                const deleteCompletedHtml = (currentUserRole === 'Admin' || currentUserRole === 'SuperAuditor') ? `
                    <button class="action-btn delete" onclick="deleteCompletedAudit(${audit.AuditID}, '${audit.DocumentNumber}'); event.stopPropagation();" title="Delete Audit">
                        üóëÔ∏è
                    </button>
                ` : '';
                
                return `
                    ${currentUserRole !== 'StoreManager' ? `
                    <button class="action-btn view" onclick="viewAudit(${audit.AuditID}); event.stopPropagation();">
                        üëÅÔ∏è View
                    </button>
                    ` : ''}
                    ${fullReportHtml}
                    ${viewReportHtml}
                    <button class="action-btn action-plan" onclick="viewActionPlan(${audit.AuditID}); event.stopPropagation();">
                        üéØ Action Plan
                    </button>
                    ${deptReportsHtml}
                    ${deleteCompletedHtml}
                `;
            } else {
                // Delete button for In Progress - Admin/SuperAuditor/Auditor can delete
                const canDeleteInProgress = (currentUserRole === 'Admin' || currentUserRole === 'SuperAuditor' || currentUserRole === 'Auditor');
                
                return `
                    <button class="action-btn continue" onclick="continueAudit(${audit.AuditID}); event.stopPropagation();">
                        ‚úèÔ∏è Continue
                    </button>
                    ${canDeleteInProgress ? `
                    <button class="action-btn delete" onclick="deleteAudit(${audit.AuditID}, '${audit.DocumentNumber}'); event.stopPropagation();">
                        üóëÔ∏è
                    </button>
                    ` : ''}
                `;
            }
        }

        function viewAudit(auditId) {
            window.location.href = `/auditor/fill-audit?id=${auditId}&readonly=true`;
        }

        function viewActionPlan(auditId) {
            window.location.href = `/auditor/action-plan?id=${auditId}`;
        }

        // View published report (for StoreManager)
        async function viewPublishedReport(auditId) {
            try {
                const response = await fetch(`/api/audits/${auditId}/published-report`);
                const data = await response.json();
                
                if (data.success && data.hasReport) {
                    window.open(`/api/audits/reports/${data.fileName}`, '_blank');
                } else {
                    alert('Report not yet published. Please contact the auditor.');
                }
            } catch (error) {
                console.error('Error viewing report:', error);
                alert('Error loading report: ' + error.message);
            }
        }

        // Check for published reports (for StoreManager)
        async function checkPublishedReports() {
            if (currentUserRole !== 'StoreManager') return;
            
            for (const audit of filteredAudits) {
                if (audit.Status === 'Completed') {
                    try {
                        const response = await fetch(`/api/audits/${audit.AuditID}/published-report`);
                        const data = await response.json();
                        
                        if (data.success && data.hasReport) {
                            const btn = document.getElementById(`viewReportBtn-${audit.AuditID}`);
                            if (btn) btn.style.display = 'inline-flex';
                        }
                    } catch (e) {
                        console.error('Error checking published report:', e);
                    }
                }
            }
        }

        // Load notification statuses for completed audits (Admin, Auditor, SuperAuditor only)
        async function loadNotificationStatuses() {
            if (currentUserRole === 'StoreManager') return;
            
            const completedAudits = filteredAudits.filter(a => a.Status === 'Completed');
            if (completedAudits.length === 0) return;
            
            // Get all audit IDs
            const auditIds = completedAudits.map(a => a.AuditID);
            
            try {
                const response = await fetch('/api/audits/notification-statuses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auditIds })
                });
                
                if (!response.ok) throw new Error('Failed to load notification statuses');
                
                const data = await response.json();
                
                // Update each card's badges
                for (const audit of completedAudits) {
                    const badgeContainer = document.getElementById(`badges-${audit.AuditID}`);
                    if (!badgeContainer) continue;
                    
                    const status = data.statuses[audit.AuditID] || {};
                    badgeContainer.innerHTML = renderNotificationBadges(status);
                }
            } catch (error) {
                console.error('Error loading notification statuses:', error);
                // Show error state on badges
                for (const audit of completedAudits) {
                    const badgeContainer = document.getElementById(`badges-${audit.AuditID}`);
                    if (badgeContainer) {
                        badgeContainer.innerHTML = `
                            <div class="notification-badge pending">
                                <span class="badge-icon">‚ö†Ô∏è</span>
                                <span>Status unavailable</span>
                            </div>
                        `;
                    }
                }
            }
        }

        // Render notification badges HTML
        function renderNotificationBadges(status) {
            let html = '';
            
            // Report sent to Store Manager badge
            if (status.reportSentDate) {
                const sentBy = status.reportSentBy ? ` by ${status.reportSentBy}` : '';
                html += `
                    <div class="notification-badge sent">
                        <span class="badge-icon">üìß</span>
                        <span>Report sent to SM${sentBy}: <span class="badge-date">${formatDate(status.reportSentDate)}</span></span>
                    </div>
                `;
            } else {
                html += `
                    <div class="notification-badge pending">
                        <span class="badge-icon">üìß</span>
                        <span>Report not sent to SM yet</span>
                    </div>
                `;
            }
            
            // Action Plan submitted badge
            if (status.actionPlanSubmittedDate) {
                const submittedBy = status.actionPlanSubmittedBy ? ` by ${status.actionPlanSubmittedBy}` : '';
                html += `
                    <div class="notification-badge submitted">
                        <span class="badge-icon">‚úÖ</span>
                        <span>Action Plan submitted${submittedBy}: <span class="badge-date">${formatDate(status.actionPlanSubmittedDate)}</span></span>
                    </div>
                `;
            } else {
                html += `
                    <div class="notification-badge pending">
                        <span class="badge-icon">‚è≥</span>
                        <span>Action Plan not submitted yet</span>
                    </div>
                `;
            }
            
            return html;
        }

        // Generate full audit report
        async function generateFullReport(auditId) {
            // Show loading
            const loading = document.createElement('div');
            loading.className = 'report-loading';
            loading.innerHTML = `
                <div class="report-loading-content">
                    <div class="report-loading-spinner"></div>
                    <div>Generating Full Report...</div>
                </div>
            `;
            document.body.appendChild(loading);
            
            try {
                const response = await fetch(`/api/audits/${auditId}/generate-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate report');
                }
                
                // Open the generated report in a new tab
                window.open(`/api/audits/reports/${result.fileName}`, '_blank');
                
            } catch (error) {
                console.error('Error generating full report:', error);
                alert('Error generating report: ' + error.message);
            } finally {
                loading.remove();
            }
        }

        // Toggle department dropdown
        function toggleDeptDropdown(auditId) {
            // Close all other dropdowns
            document.querySelectorAll('.dept-dropdown-content').forEach(dd => {
                if (dd.id !== `dept-dropdown-${auditId}`) {
                    dd.classList.remove('show');
                }
            });
            // Toggle this one
            const dropdown = document.getElementById(`dept-dropdown-${auditId}`);
            dropdown.classList.toggle('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dept-reports-dropdown')) {
                document.querySelectorAll('.dept-dropdown-content').forEach(dd => {
                    dd.classList.remove('show');
                });
            }
        });

        // Generate department report
        async function generateDeptReport(auditId, department) {
            // Close dropdown
            document.querySelectorAll('.dept-dropdown-content').forEach(dd => dd.classList.remove('show'));
            
            // Show loading
            const loading = document.createElement('div');
            loading.className = 'report-loading';
            loading.innerHTML = `
                <div class="report-loading-content">
                    <div class="report-loading-spinner"></div>
                    <div>Generating ${department} Report...</div>
                    <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">This may take a few minutes for large audits with many pictures...</div>
                </div>
            `;
            document.body.appendChild(loading);
            
            try {
                // Use AbortController with 5 minute timeout for large reports with many pictures
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minutes
                
                // Use POST endpoint that generates server-side HTML file (handles large images)
                const response = await fetch(`/api/audits/${auditId}/generate-department-report/${department}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate report');
                }
                
                if (result.totalFindings === 0) {
                    loading.remove();
                    alert(`No items found for ${department} department in this audit.`);
                    return;
                }
                
                // Open the server-generated report file
                window.open(`/api/audits/reports/${result.fileName}`, '_blank');
                
            } catch (error) {
                console.error('Error generating department report:', error);
                if (error.name === 'AbortError') {
                    alert('Report generation timed out. The audit may have too many pictures. Please try again or contact support.');
                } else {
                    alert('Error generating report: ' + error.message);
                }
            } finally {
                loading.remove();
            }
        }

        // Generate department report HTML
        function generateDepartmentReportHTML(report) {
            const deptColors = {
                'Maintenance': { bg: '#dbeafe', border: '#2563eb', text: '#1e40af', icon: 'üîß' },
                'Procurement': { bg: '#ede9fe', border: '#7c3aed', text: '#5b21b6', icon: 'üì¶' },
                'Cleaning': { bg: '#d1fae5', border: '#059669', text: '#065f46', icon: 'üßπ' }
            };
            const colors = deptColors[report.department] || deptColors['Maintenance'];
            const displayName = report.departmentDisplayName || report.department;
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            let itemsHTML = report.items.map((item, index) => {
                const pColor = priorityColors[item.priority] || priorityColors['Medium'];
                
                let picturesHTML = '';
                if (item.pictures && item.pictures.length > 0) {
                    picturesHTML = `
                        <div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                ${item.pictures.map(pic => `
                                    <img src="data:${pic.contentType};base64,${pic.base64}" 
                                         alt="${pic.fileName}" 
                                         style="width: 70px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #e5e7eb;" />
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <tr id="ref-${item.referenceValue.replace(/\./g, '-')}">
                        <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: ${colors.text};">${item.referenceValue}</td>
                        <td style="padding: 12px; border: 1px solid #e5e7eb;">
                            <div style="color: ${colors.text}; font-size: 11px; font-weight: 600; margin-bottom: 4px;">${item.section}</div>
                            <span style="font-size: 13px;">${item.title}</span>
                        </td>
                        <td class="finding-cell" style="padding: 12px; border: 1px solid #e5e7eb; font-size: 13px;">${item.finding || '-'}</td>
                        <td class="action-cell" style="padding: 12px; border: 1px solid #e5e7eb; font-size: 13px;">${item.correctiveAction || '-'}</td>
                        <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">
                            <span style="background: ${pColor.bg}; color: ${pColor.text}; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">${item.priority}</span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #e5e7eb;">${picturesHTML || '<span style="color: #9ca3af; font-size: 12px;">No pictures</span>'}</td>
                    </tr>
                `;
            }).join('');
            
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${displayName} Report - ${report.audit.documentNumber}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: ${colors.bg}; border-bottom: 4px solid ${colors.border}; padding: 30px; }
        .header h1 { color: ${colors.text}; font-size: 28px; margin-bottom: 10px; }
        .header-info { display: flex; gap: 30px; flex-wrap: wrap; margin-top: 15px; }
        .header-info-item { color: #374151; }
        .header-info-item strong { color: ${colors.text}; }
        .summary { display: flex; gap: 20px; padding: 20px 30px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .summary-item { padding: 15px 25px; background: white; border-radius: 8px; border-left: 4px solid ${colors.border}; }
        .summary-item .label { color: #6b7280; font-size: 12px; text-transform: uppercase; }
        .summary-item .value { font-size: 24px; font-weight: 700; color: ${colors.text}; }
        .content { padding: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: ${colors.bg}; color: ${colors.text}; padding: 14px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600; }
        td { word-wrap: break-word; overflow-wrap: break-word; }
        .finding-cell, .action-cell { white-space: pre-line; line-height: 1.6; }
        .footer { padding: 20px 30px; background: #f9fafb; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px; }
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${colors.icon} ${displayName} Department Report</h1>
            <div class="header-info">
                <div class="header-info-item"><strong>Document:</strong> ${report.audit.documentNumber}</div>
                <div class="header-info-item"><strong>Store:</strong> ${report.audit.storeName}</div>
                <div class="header-info-item"><strong>Date:</strong> ${new Date(report.audit.auditDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</div>
                <div class="header-info-item"><strong>Cycle:</strong> ${report.audit.cycle} / ${report.audit.year}</div>
                <div class="header-info-item"><strong>Auditors:</strong> ${report.audit.auditors || '-'}</div>
            </div>
        </div>
        <div class="summary">
            <div class="summary-item">
                <div class="label">Total Items</div>
                <div class="value">${report.totalItems}</div>
            </div>
            <div class="summary-item" style="border-left-color: #ef4444;">
                <div class="label">High Priority</div>
                <div class="value" style="color: #ef4444;">${report.byPriority.high}</div>
            </div>
            <div class="summary-item" style="border-left-color: #f59e0b;">
                <div class="label">Medium Priority</div>
                <div class="value" style="color: #f59e0b;">${report.byPriority.medium}</div>
            </div>
            <div class="summary-item" style="border-left-color: #10b981;">
                <div class="label">Low Priority</div>
                <div class="value" style="color: #10b981;">${report.byPriority.low}</div>
            </div>
        </div>
        <div class="content">
            <table>
                <thead>
                    <tr>
                        <th style="width: 60px;">Ref #</th>
                        <th style="width: 200px;">Item</th>
                        <th style="width: 25%;">Finding</th>
                        <th style="width: 25%;">Corrective Action</th>
                        <th style="width: 80px;">Priority</th>
                        <th style="width: 180px;">Pictures</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHTML}
                </tbody>
            </table>
        </div>
        ${generateFindingGalleryHTML(report, colors)}
        ${generateGoodGalleryHTML(report, colors)}
        ${generateCorrectiveGalleryHTML(report, colors)}
        <div class="footer no-print" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button id="printCompressedBtn" onclick="printCompressed()" style="padding: 10px 20px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üñ®Ô∏è Print (Fast - Compressed)</button>
            <button onclick="window.print()" style="padding: 10px 20px; background: ${colors.border}; color: white; border: none; border-radius: 6px; cursor: pointer;">üñ®Ô∏è Print (Full Quality)</button>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;" onclick="this.style.display='none'">
        <span style="position: absolute; top: 20px; right: 40px; color: white; font-size: 40px; font-weight: bold; cursor: pointer;">&times;</span>
        <img id="modalImage" style="max-width: 90%; max-height: 90%; object-fit: contain;" />
    </div>

    <scr` + `ipt>
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'flex';
        }
        function scrollToRef(refId) {
            const element = document.getElementById('ref-' + refId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.backgroundColor = '#fef3c7';
                setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
            }
        }
        
        // Compress images and print - reduces PDF size significantly
        async function printCompressed() {
            const btn = document.getElementById('printCompressedBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Compressing images...';
            
            const images = document.querySelectorAll('img');
            const totalImages = images.length;
            
            try {
                let processed = 0;
                
                for (const img of images) {
                    // Skip small images or modal image
                    if (img.id === 'modalImage' || img.naturalWidth < 100 || img.naturalHeight < 100) {
                        processed++;
                        continue;
                    }
                    
                    // Compress using canvas
                    await new Promise((resolve) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Reduce size: max 600px wide, maintain aspect ratio
                        const maxWidth = 600;
                        const scale = Math.min(1, maxWidth / img.naturalWidth);
                        canvas.width = img.naturalWidth * scale;
                        canvas.height = img.naturalHeight * scale;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Convert to JPEG at 50% quality (much smaller than PNG)
                        const compressedSrc = canvas.toDataURL('image/jpeg', 0.5);
                        img.src = compressedSrc;
                        
                        processed++;
                        if (processed % 20 === 0) {
                            btn.innerHTML = '‚è≥ Compressing... ' + processed + '/' + totalImages;
                        }
                        
                        resolve();
                    });
                }
                
                btn.innerHTML = 'üñ®Ô∏è Opening print dialog...';
                
                // Small delay to let images update
                await new Promise(r => setTimeout(r, 500));
                
                // Print
                window.print();
                
                btn.innerHTML = '‚úÖ Print ready';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('Compression error:', error);
                // Fallback to regular print
                window.print();
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </scr` + `ipt>
</body>
</html>
            `;
        }

        // Generate Finding Picture Gallery HTML for department reports
        function generateFindingGalleryHTML(report, colors) {
            // Collect only finding pictures (not corrective)
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Finding type pictures
                    const findingPics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'finding'
                    );
                    
                    for (const pic of findingPics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            finding: item.finding,
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #fef3c7; border-bottom: 1px solid #fcd34d;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #dc2626; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #f5f5f5; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Finding ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
                    <h2 style="color: #92400e; margin-bottom: 10px;">üì∏ Finding Picture Gallery (${allPictures.length})</h2>
                    <p style="color: #78350f; font-size: 0.9rem; margin-bottom: 20px;">All finding pictures collected for easy reference. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }

        // Generate Good Observation Picture Gallery HTML for department reports
        function generateGoodGalleryHTML(report, colors) {
            // Collect only good observation pictures
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Good type pictures
                    const goodPics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'good'
                    );
                    
                    for (const pic of goodPics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            comment: item.comment || '',
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #a7f3d0;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #d1fae5; border-bottom: 1px solid #6ee7b7;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #059669; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #f0fdf4; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Good Observation ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #d1fae5; border: 2px solid #10b981; border-radius: 12px;">
                    <h2 style="color: #065f46; margin-bottom: 10px;">‚úÖ Good Observation Gallery (${allPictures.length})</h2>
                    <p style="color: #047857; font-size: 0.9rem; margin-bottom: 20px;">All good observation pictures collected for easy reference. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }

        // Generate Corrective Action Picture Gallery HTML for department reports
        function generateCorrectiveGalleryHTML(report, colors) {
            // Collect only corrective pictures
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Corrective type pictures
                    const correctivePics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'corrective'
                    );
                    
                    for (const pic of correctivePics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            finding: item.finding,
                            correctiveAction: item.correctiveAction,
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #93c5fd;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #dbeafe; border-bottom: 1px solid #60a5fa;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #2563eb; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #eff6ff; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Corrective Action ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 12px;">
                    <h2 style="color: #1e40af; margin-bottom: 10px;">üîß Corrective Action Gallery (${allPictures.length})</h2>
                    <p style="color: #1d4ed8; font-size: 0.9rem; margin-bottom: 20px;">All corrective action pictures showing fixes applied. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }

        function continueAudit(auditId) {
            window.location.href = `/auditor/fill-audit?id=${auditId}`;
        }

        async function deleteAudit(auditId, documentNumber) {
            if (!confirm(`Are you sure you want to delete this audit?\n\nDocument: ${documentNumber || auditId}\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/audits/${auditId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Failed to delete audit');

                alert(`Audit ${documentNumber || ''} deleted successfully.`);
                await loadAudits();
            } catch (error) {
                console.error('Error deleting audit:', error);
                alert('Failed to delete audit: ' + error.message);
            }
        }

        // Delete completed audit - requires double confirmation
        async function deleteCompletedAudit(auditId, documentNumber) {
            // First confirmation
            if (!confirm(`‚ö†Ô∏è WARNING: You are about to delete a COMPLETED audit!\n\nDocument: ${documentNumber}\n\nThis will permanently delete:\n‚Ä¢ All audit responses\n‚Ä¢ All pictures\n‚Ä¢ All section scores\n‚Ä¢ Published reports references\n\nThis action CANNOT be undone.`)) {
                return;
            }
            
            // Second confirmation - type document number
            const confirmInput = prompt(`To confirm deletion, please type the document number:\n\n${documentNumber}`);
            
            if (confirmInput !== documentNumber) {
                alert('Document number did not match. Deletion cancelled.');
                return;
            }

            try {
                const response = await fetch(`/api/audits/${auditId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Failed to delete audit');

                alert(`‚úÖ Audit ${documentNumber} has been permanently deleted.`);
                await loadAudits();
            } catch (error) {
                console.error('Error deleting audit:', error);
                alert('Failed to delete audit: ' + error.message);
            }
        }

        // ==========================================
        // Notification Bell Functions
        // ==========================================
        
        let notificationPanelOpen = false;

        // Load unread count on page load
        async function loadUnreadCount() {
            try {
                const response = await fetch('/api/broadcast/unread-count');
                if (response.ok) {
                    const data = await response.json();
                    updateBellBadge(data.count || 0);
                }
            } catch (error) {
                console.error('Error loading unread count:', error);
            }
        }

        function updateBellBadge(count) {
            const badge = document.getElementById('bellBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            notificationPanelOpen = !notificationPanelOpen;
            panel.classList.toggle('show', notificationPanelOpen);
            
            if (notificationPanelOpen) {
                loadNotifications();
            }
        }

        // Close panel when clicking outside
        document.addEventListener('click', function(e) {
            const bell = document.getElementById('notificationBell');
            const panel = document.getElementById('notificationPanel');
            
            if (notificationPanelOpen && !bell.contains(e.target) && !panel.contains(e.target)) {
                notificationPanelOpen = false;
                panel.classList.remove('show');
            }
        });

        async function loadNotifications() {
            const list = document.getElementById('notificationList');
            list.innerHTML = '<div class="notification-empty"><p>Loading...</p></div>';
            
            try {
                const response = await fetch('/api/broadcast/my-notifications');
                const data = await response.json();
                
                if (!data.success || !data.notifications || data.notifications.length === 0) {
                    list.innerHTML = `
                        <div class="notification-empty">
                            <div class="notification-empty-icon">üîî</div>
                            <p>No notifications</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                for (const n of data.notifications) {
                    const isUnread = !n.read_at;
                    const date = new Date(n.sent_at).toLocaleDateString('en-US', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const typeIcons = { Announcement: 'üì¢', Reminder: '‚ö†Ô∏è', Urgent: 'üö®' };
                    
                    html += `
                        <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="markAsRead(${n.recipient_id})">
                            <div class="notification-item-header">
                                <span class="notification-item-type ${n.broadcast_type.toLowerCase()}">${typeIcons[n.broadcast_type] || 'üì¢'} ${n.broadcast_type}</span>
                                <button class="notification-item-dismiss" onclick="event.stopPropagation(); dismissNotification(${n.recipient_id})" title="Dismiss">‚úï</button>
                            </div>
                            <div class="notification-item-title">${escapeHtml(n.title)}</div>
                            <div class="notification-item-message">${escapeHtml(n.message)}</div>
                            <div class="notification-item-meta">From ${n.sent_by_name} ‚Ä¢ ${date}</div>
                        </div>
                    `;
                }
                
                list.innerHTML = html;
            } catch (error) {
                list.innerHTML = `
                    <div class="notification-empty">
                        <div class="notification-empty-icon">‚ùå</div>
                        <p>Error loading notifications</p>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function markAsRead(recipientId) {
            try {
                await fetch('/api/broadcast/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipientId })
                });
                loadNotifications();
                loadUnreadCount();
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        async function dismissNotification(recipientId) {
            try {
                await fetch('/api/broadcast/dismiss', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipientId })
                });
                loadNotifications();
                loadUnreadCount();
            } catch (error) {
                console.error('Error dismissing notification:', error);
            }
        }

        async function markAllAsRead() {
            try {
                await fetch('/api/broadcast/mark-all-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                loadNotifications();
                loadUnreadCount();
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }

        // Load unread count on page load
        loadUnreadCount();
        // Refresh count every 30 seconds
        setInterval(loadUnreadCount, 30000);
    </script>
</body>
</html>
