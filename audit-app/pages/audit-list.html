<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit List - Food Safety Audit System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1e3a5f;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .filters-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .stat-card .label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        .stat-card.completed .number { color: #10b981; }
        .stat-card.in-progress .number { color: #f59e0b; }

        /* Score Colors */
        .score-pass { color: #10b981 !important; }
        .score-fail { color: #ef4444 !important; }
        .score-na { color: #9ca3af !important; }

        /* Card Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .audit-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .audit-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .card-header.pass {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .card-header.fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .card-header.in-progress {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .card-header.draft {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .doc-number {
            font-size: 16px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-completed {
            background: #065f46;
            color: white;
        }

        .status-in-progress {
            background: #92400e;
            color: white;
        }

        .status-draft {
            background: #4b5563;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-info-simple {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row .info-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }

        .info-row .info-value {
            font-size: 14px;
            color: #1e3a5f;
            font-weight: 600;
        }

        .info-row .info-value.store-name {
            font-size: 16px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .info-row .info-value.score-value {
            font-size: 18px;
            font-weight: 700;
        }

        .info-row.checklist-info-row {
            background: #f8fafc;
            margin: 8px -20px -4px -20px;
            padding: 10px 20px;
            border-top: 1px solid #e5e7eb;
        }

        .checklist-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .checklist-edition {
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .checklist-creation {
            background: #d1fae5;
            color: #065f46;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .checklist-revision {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .info-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-value {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .auditors-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .auditor-tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .card-footer {
            padding: 16px 20px;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #f3f4f6;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
        }

        .score-circle.pass {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .score-circle.fail {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .score-circle.na {
            background: #9ca3af;
            font-size: 20px;
        }

        .score-value.score-pass {
            color: #059669;
        }

        .score-value.score-fail {
            color: #dc2626;
        }

        .score-value.score-na {
            color: #9ca3af;
        }

        .score-label {
            font-size: 12px;
            color: #6b7280;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn.view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .action-btn.view:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .action-btn.continue {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .action-btn.continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #991b1b;
            padding: 10px 12px;
        }

        .action-btn.delete:hover {
            background: #fecaca;
        }

        .action-btn.action-plan {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .action-btn.action-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .action-btn.full-report {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
        }

        .action-btn.full-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }

        .action-btn.view-report {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }

        .action-btn.view-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }

        /* Department Reports Dropdown */
        .dept-reports-dropdown {
            position: relative;
            display: inline-block;
        }

        .action-btn.dept-reports {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .action-btn.dept-reports:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .dept-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            bottom: 100%;
            margin-bottom: 5px;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 1000;
            overflow: hidden;
        }

        .dept-dropdown-content.show {
            display: block;
        }

        .dept-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            text-decoration: none;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dept-dropdown-item:hover {
            background: #f3f4f6;
        }

        .dept-dropdown-item.maintenance {
            color: #2563eb;
        }

        .dept-dropdown-item.procurement {
            color: #7c3aed;
        }

        .dept-dropdown-item.cleaning {
            color: #059669;
        }

        /* Loading overlay */
        .report-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .report-loading-content {
            background: white;
            padding: 30px 50px;
            border-radius: 12px;
            text-align: center;
        }

        .report-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #374151;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .filters-bar {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .card-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Audit List</h1>
        <div class="header-actions">
            <button id="startNewAuditBtn" class="btn btn-primary" onclick="window.location.href='/auditor/start-audit'" style="display: none;">
                <span>üöÄ</span> Start New Audit
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='/dashboard'">
                <span>üè†</span> Dashboard
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="number" id="totalAudits">0</div>
                <div class="label">Total Audits</div>
            </div>
            <div class="stat-card completed">
                <div class="number" id="completedAudits">0</div>
                <div class="label">Completed</div>
            </div>
            <div class="stat-card in-progress">
                <div class="number" id="inProgressAudits">0</div>
                <div class="label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="number" id="avgScore">-</div>
                <div class="label">Avg. Score</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="filter-group">
                <label>Status</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="">All Statuses</option>
                    <option value="Completed">Completed</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Draft">Draft</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Store</label>
                <select id="storeFilter" onchange="applyFilters()">
                    <option value="">All Stores</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Year</label>
                <select id="yearFilter" onchange="applyFilters()">
                    <option value="">All Years</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Cycle</label>
                <select id="cycleFilter" onchange="applyFilters()">
                    <option value="">All Cycles</option>
                    <option value="C1">C1 (Jan-Feb)</option>
                    <option value="C2">C2 (Mar-Apr)</option>
                    <option value="C3">C3 (May-Jun)</option>
                    <option value="C4">C4 (Jul-Aug)</option>
                    <option value="C5">C5 (Sep-Oct)</option>
                    <option value="C6">C6 (Nov-Dec)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="searchInput" placeholder="Document # or Store" oninput="applyFilters()">
            </div>
        </div>

        <!-- Cards Grid -->
        <div id="cardsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading audits...</div>
            </div>
        </div>
    </div>

    <!-- Impersonation Panel Script -->
    <script src="/auth/scripts/impersonation-panel.js?v=9"></script>

    <script>
        let allAudits = [];
        let filteredAudits = [];
        let currentUserRole = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize impersonation panel for admins
            if (typeof initImpersonationPanel === 'function') {
                initImpersonationPanel();
            }
            
            // Check user role and show/hide Start New Audit button
            try {
                const sessionRes = await fetch('/auth/session');
                if (sessionRes.ok) {
                    const sessionData = await sessionRes.json();
                    currentUserRole = sessionData.user?.role;
                    // Only show Start New Audit for Admin, SuperAuditor, and Auditor
                    if (currentUserRole === 'Admin' || currentUserRole === 'SuperAuditor' || currentUserRole === 'Auditor') {
                        document.getElementById('startNewAuditBtn').style.display = 'flex';
                    }
                }
            } catch (e) {
                console.error('Error checking user role:', e);
            }
            
            await loadAudits();
        });

        async function loadAudits() {
            try {
                const response = await fetch('/api/audits/list');
                
                // Handle authentication errors
                if (response.status === 401) {
                    window.location.href = '/auth/login?returnUrl=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Failed to load audits');
                }
                
                allAudits = data.audits || [];
                
                // Populate filters
                populateFilters();
                
                // Update stats
                updateStats();
                
                // Apply initial filters
                applyFilters();
                
            } catch (error) {
                console.error('Error loading audits:', error);
                document.getElementById('cardsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <h3>Error Loading Audits</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function populateFilters() {
            // Populate stores
            const stores = [...new Set(allAudits.map(a => a.StoreName).filter(Boolean))];
            const storeSelect = document.getElementById('storeFilter');
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelect.appendChild(option);
            });

            // Populate years
            const years = [...new Set(allAudits.map(a => a.AuditYear).filter(Boolean))].sort((a, b) => b - a);
            const yearSelect = document.getElementById('yearFilter');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        function updateStats() {
            const total = allAudits.length;
            const completed = allAudits.filter(a => a.Status === 'Completed').length;
            const inProgress = allAudits.filter(a => a.Status === 'In Progress').length;
            
            const completedWithScores = allAudits.filter(a => a.Status === 'Completed' && a.TotalScore !== null);
            const avgScore = completedWithScores.length > 0 
                ? Math.round(completedWithScores.reduce((sum, a) => sum + a.TotalScore, 0) / completedWithScores.length)
                : '-';

            document.getElementById('totalAudits').textContent = total;
            document.getElementById('completedAudits').textContent = completed;
            document.getElementById('inProgressAudits').textContent = inProgress;
            document.getElementById('avgScore').textContent = avgScore !== '-' ? avgScore + '%' : '-';
        }

        function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const store = document.getElementById('storeFilter').value;
            const year = document.getElementById('yearFilter').value;
            const cycle = document.getElementById('cycleFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredAudits = allAudits.filter(audit => {
                if (status && audit.Status !== status) return false;
                if (store && audit.StoreName !== store) return false;
                if (year && audit.AuditYear != year) return false;
                if (cycle && audit.AuditCycle !== cycle) return false;
                if (search) {
                    const matchesDoc = audit.DocumentNumber?.toLowerCase().includes(search);
                    const matchesStore = audit.StoreName?.toLowerCase().includes(search);
                    if (!matchesDoc && !matchesStore) return false;
                }
                return true;
            });

            renderCards();
            
            // Check for published reports (for StoreManager)
            checkPublishedReports();
        }

        function renderCards() {
            if (filteredAudits.length === 0) {
                document.getElementById('cardsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <h3>No Audits Found</h3>
                        <p>No audits match your filter criteria. Try adjusting the filters or start a new audit.</p>
                    </div>
                `;
                return;
            }

            const cardsHtml = `
                <div class="cards-grid">
                    ${filteredAudits.map(audit => renderCard(audit)).join('')}
                </div>
            `;

            document.getElementById('cardsContainer').innerHTML = cardsHtml;
        }

        function renderCard(audit) {
            const statusClass = audit.Status?.toLowerCase().replace(' ', '-') || 'draft';
            const auditors = (audit.Auditors || '').split(',').filter(a => a.trim());
            const auditorName = auditors.length > 0 ? auditors[0].trim() : 'Not Assigned';
            
            // For completed audits, use pass/fail based on system setting threshold
            let headerClass = statusClass;
            const passingGrade = audit.PassingGrade || 83;
            if (audit.Status === 'Completed' && audit.TotalScore !== null) {
                headerClass = audit.TotalScore >= passingGrade ? 'pass' : 'fail';
            }
            
            const score = audit.TotalScore !== null ? Math.round(audit.TotalScore) : null;
            const scoreClass = score !== null ? (score >= passingGrade ? 'pass' : 'fail') : 'na';
            
            return `
                <div class="audit-card">
                    <div class="card-header ${headerClass}">
                        <div class="doc-number">${audit.DocumentNumber || '-'}</div>
                        <span class="status-badge status-${statusClass}">
                            ${audit.Status === 'Completed' ? '‚úì ' : audit.Status === 'In Progress' ? '‚è≥ ' : ''}${audit.Status || 'Draft'}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="card-info-simple">
                            <div class="info-row">
                                <span class="info-label">üè™ Store</span>
                                <span class="info-value store-name">${audit.StoreName || 'Unknown Store'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üîÑ Cycle</span>
                                <span class="info-value">${audit.AuditCycle || '-'} / ${audit.AuditYear || '-'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üë§ Auditor</span>
                                <span class="info-value">${auditorName}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üìä Score</span>
                                <span class="info-value score-value score-${scoreClass}">${score !== null ? score + '%' : '‚Äî'}</span>
                            </div>
                            <div class="info-row checklist-info-row">
                                <span class="info-label">üìã Checklist</span>
                                <span class="info-value checklist-meta">
                                    ${audit.ChecklistEdition ? '<span class="checklist-edition">Ed: ' + audit.ChecklistEdition + '</span>' : ''}
                                    ${audit.ChecklistCreationDate ? '<span class="checklist-creation">Created: ' + formatDate(audit.ChecklistCreationDate) + '</span>' : ''}
                                    ${audit.ChecklistRevisionDate ? '<span class="checklist-revision">Rev: ' + formatDate(audit.ChecklistRevisionDate) + '</span>' : ''}
                                    ${!audit.ChecklistEdition && !audit.ChecklistRevisionDate && !audit.ChecklistCreationDate ? '‚Äî' : ''}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="card-actions">
                            ${renderActions(audit)}
                        </div>
                    </div>
                </div>
            `;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        function renderScoreCircle(audit) {
            if (audit.Status !== 'Completed' || audit.TotalScore === null) {
                return '<div class="score-circle na">‚Äî</div>';
            }
            const score = Math.round(audit.TotalScore);
            const passingGrade = audit.PassingGrade || 83;
            const cssClass = score >= passingGrade ? 'pass' : 'fail';
            return `<div class="score-circle ${cssClass}">${score}%</div>`;
        }

        function renderActions(audit) {
            if (audit.Status === 'Completed') {
                // Full Report and Department Reports - hidden for StoreManager
                const fullReportHtml = (currentUserRole !== 'StoreManager') ? `
                    <button class="action-btn full-report" onclick="generateFullReport(${audit.AuditID}); event.stopPropagation();">
                        üìä Full Report
                    </button>
                ` : '';
                
                // View Published Report - for StoreManager only
                const viewReportHtml = (currentUserRole === 'StoreManager') ? `
                    <button class="action-btn view-report" id="viewReportBtn-${audit.AuditID}" onclick="viewPublishedReport(${audit.AuditID}); event.stopPropagation();" style="display:none;">
                        üìÑ View Report
                    </button>
                ` : '';
                
                const deptReportsHtml = (currentUserRole !== 'StoreManager') ? `
                    <div class="dept-reports-dropdown">
                        <button class="action-btn dept-reports" onclick="toggleDeptDropdown(${audit.AuditID}); event.stopPropagation();">
                            üìã Dept Reports ‚ñæ
                        </button>
                        <div class="dept-dropdown-content" id="dept-dropdown-${audit.AuditID}">
                            <button class="dept-dropdown-item maintenance" onclick="generateDeptReport(${audit.AuditID}, 'Maintenance'); event.stopPropagation();">
                                üîß Maintenance Report
                            </button>
                            <button class="dept-dropdown-item procurement" onclick="generateDeptReport(${audit.AuditID}, 'Procurement'); event.stopPropagation();">
                                üì¶ Procurement Report
                            </button>
                            <button class="dept-dropdown-item cleaning" onclick="generateDeptReport(${audit.AuditID}, 'Cleaning'); event.stopPropagation();">
                                üßπ Cleaning Report
                            </button>
                        </div>
                    </div>
                ` : '';
                
                return `
                    ${currentUserRole !== 'StoreManager' ? `
                    <button class="action-btn view" onclick="viewAudit(${audit.AuditID}); event.stopPropagation();">
                        üëÅÔ∏è View
                    </button>
                    ` : ''}
                    ${fullReportHtml}
                    ${viewReportHtml}
                    <button class="action-btn action-plan" onclick="viewActionPlan(${audit.AuditID}); event.stopPropagation();">
                        üéØ Action Plan
                    </button>
                    ${deptReportsHtml}
                `;
            } else {
                return `
                    <button class="action-btn continue" onclick="continueAudit(${audit.AuditID}); event.stopPropagation();">
                        ‚úèÔ∏è Continue
                    </button>
                    <button class="action-btn delete" onclick="deleteAudit(${audit.AuditID}); event.stopPropagation();">
                        üóëÔ∏è
                    </button>
                `;
            }
        }

        function viewAudit(auditId) {
            window.location.href = `/auditor/fill-audit?id=${auditId}&readonly=true`;
        }

        function viewActionPlan(auditId) {
            window.location.href = `/auditor/action-plan?id=${auditId}`;
        }

        // View published report (for StoreManager)
        async function viewPublishedReport(auditId) {
            try {
                const response = await fetch(`/api/audits/${auditId}/published-report`);
                const data = await response.json();
                
                if (data.success && data.hasReport) {
                    window.open(`/api/audits/reports/${data.fileName}`, '_blank');
                } else {
                    alert('Report not yet published. Please contact the auditor.');
                }
            } catch (error) {
                console.error('Error viewing report:', error);
                alert('Error loading report: ' + error.message);
            }
        }

        // Check for published reports (for StoreManager)
        async function checkPublishedReports() {
            if (currentUserRole !== 'StoreManager') return;
            
            for (const audit of filteredAudits) {
                if (audit.Status === 'Completed') {
                    try {
                        const response = await fetch(`/api/audits/${audit.AuditID}/published-report`);
                        const data = await response.json();
                        
                        if (data.success && data.hasReport) {
                            const btn = document.getElementById(`viewReportBtn-${audit.AuditID}`);
                            if (btn) btn.style.display = 'inline-flex';
                        }
                    } catch (e) {
                        console.error('Error checking published report:', e);
                    }
                }
            }
        }

        // Generate full audit report
        async function generateFullReport(auditId) {
            // Show loading
            const loading = document.createElement('div');
            loading.className = 'report-loading';
            loading.innerHTML = `
                <div class="report-loading-content">
                    <div class="report-loading-spinner"></div>
                    <div>Generating Full Report...</div>
                </div>
            `;
            document.body.appendChild(loading);
            
            try {
                const response = await fetch(`/api/audits/${auditId}/generate-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate report');
                }
                
                // Open the generated report in a new tab
                window.open(`/api/audits/reports/${result.fileName}`, '_blank');
                
            } catch (error) {
                console.error('Error generating full report:', error);
                alert('Error generating report: ' + error.message);
            } finally {
                loading.remove();
            }
        }

        // Toggle department dropdown
        function toggleDeptDropdown(auditId) {
            // Close all other dropdowns
            document.querySelectorAll('.dept-dropdown-content').forEach(dd => {
                if (dd.id !== `dept-dropdown-${auditId}`) {
                    dd.classList.remove('show');
                }
            });
            // Toggle this one
            const dropdown = document.getElementById(`dept-dropdown-${auditId}`);
            dropdown.classList.toggle('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dept-reports-dropdown')) {
                document.querySelectorAll('.dept-dropdown-content').forEach(dd => {
                    dd.classList.remove('show');
                });
            }
        });

        // Generate department report
        async function generateDeptReport(auditId, department) {
            // Close dropdown
            document.querySelectorAll('.dept-dropdown-content').forEach(dd => dd.classList.remove('show'));
            
            // Show loading
            const loading = document.createElement('div');
            loading.className = 'report-loading';
            loading.innerHTML = `
                <div class="report-loading-content">
                    <div class="report-loading-spinner"></div>
                    <div>Generating ${department} Report...</div>
                </div>
            `;
            document.body.appendChild(loading);
            
            try {
                const response = await fetch(`/api/audits/${auditId}/department-report/${department}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate report');
                }
                
                const report = result.data;
                
                if (report.items.length === 0) {
                    loading.remove();
                    alert(`No items found for ${department} department in this audit.`);
                    return;
                }
                
                // Generate and open HTML report
                const html = generateDepartmentReportHTML(report);
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                
            } catch (error) {
                console.error('Error generating department report:', error);
                alert('Error generating report: ' + error.message);
            } finally {
                loading.remove();
            }
        }

        // Generate department report HTML
        function generateDepartmentReportHTML(report) {
            const deptColors = {
                'Maintenance': { bg: '#dbeafe', border: '#2563eb', text: '#1e40af', icon: 'üîß' },
                'Procurement': { bg: '#ede9fe', border: '#7c3aed', text: '#5b21b6', icon: 'üì¶' },
                'Cleaning': { bg: '#d1fae5', border: '#059669', text: '#065f46', icon: 'üßπ' }
            };
            const colors = deptColors[report.department] || deptColors['Maintenance'];
            const displayName = report.departmentDisplayName || report.department;
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            let itemsHTML = report.items.map((item, index) => {
                const pColor = priorityColors[item.priority] || priorityColors['Medium'];
                
                let picturesHTML = '';
                if (item.pictures && item.pictures.length > 0) {
                    picturesHTML = `
                        <div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                ${item.pictures.map(pic => `
                                    <img src="data:${pic.contentType};base64,${pic.base64}" 
                                         alt="${pic.fileName}" 
                                         style="width: 70px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #e5e7eb;" />
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <tr id="ref-${item.referenceValue.replace(/\./g, '-')}">
                        <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: ${colors.text};">${item.referenceValue}</td>
                        <td style="padding: 12px; border: 1px solid #e5e7eb;">
                            <div style="color: ${colors.text}; font-size: 11px; font-weight: 600; margin-bottom: 4px;">${item.section}</div>
                            <span style="font-size: 13px;">${item.title}</span>
                        </td>
                        <td class="finding-cell" style="padding: 12px; border: 1px solid #e5e7eb; font-size: 13px;">${item.finding || '-'}</td>
                        <td class="action-cell" style="padding: 12px; border: 1px solid #e5e7eb; font-size: 13px;">${item.correctiveAction || '-'}</td>
                        <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">
                            <span style="background: ${pColor.bg}; color: ${pColor.text}; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">${item.priority}</span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #e5e7eb;">${picturesHTML || '<span style="color: #9ca3af; font-size: 12px;">No pictures</span>'}</td>
                    </tr>
                `;
            }).join('');
            
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${displayName} Report - ${report.audit.documentNumber}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: ${colors.bg}; border-bottom: 4px solid ${colors.border}; padding: 30px; }
        .header h1 { color: ${colors.text}; font-size: 28px; margin-bottom: 10px; }
        .header-info { display: flex; gap: 30px; flex-wrap: wrap; margin-top: 15px; }
        .header-info-item { color: #374151; }
        .header-info-item strong { color: ${colors.text}; }
        .summary { display: flex; gap: 20px; padding: 20px 30px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .summary-item { padding: 15px 25px; background: white; border-radius: 8px; border-left: 4px solid ${colors.border}; }
        .summary-item .label { color: #6b7280; font-size: 12px; text-transform: uppercase; }
        .summary-item .value { font-size: 24px; font-weight: 700; color: ${colors.text}; }
        .content { padding: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: ${colors.bg}; color: ${colors.text}; padding: 14px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600; }
        td { word-wrap: break-word; overflow-wrap: break-word; }
        .finding-cell, .action-cell { white-space: pre-line; line-height: 1.6; }
        .footer { padding: 20px 30px; background: #f9fafb; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px; }
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${colors.icon} ${displayName} Department Report</h1>
            <div class="header-info">
                <div class="header-info-item"><strong>Document:</strong> ${report.audit.documentNumber}</div>
                <div class="header-info-item"><strong>Store:</strong> ${report.audit.storeName}</div>
                <div class="header-info-item"><strong>Date:</strong> ${new Date(report.audit.auditDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</div>
                <div class="header-info-item"><strong>Cycle:</strong> ${report.audit.cycle} / ${report.audit.year}</div>
                <div class="header-info-item"><strong>Auditors:</strong> ${report.audit.auditors || '-'}</div>
            </div>
        </div>
        <div class="summary">
            <div class="summary-item">
                <div class="label">Total Items</div>
                <div class="value">${report.totalItems}</div>
            </div>
            <div class="summary-item" style="border-left-color: #ef4444;">
                <div class="label">High Priority</div>
                <div class="value" style="color: #ef4444;">${report.byPriority.high}</div>
            </div>
            <div class="summary-item" style="border-left-color: #f59e0b;">
                <div class="label">Medium Priority</div>
                <div class="value" style="color: #f59e0b;">${report.byPriority.medium}</div>
            </div>
            <div class="summary-item" style="border-left-color: #10b981;">
                <div class="label">Low Priority</div>
                <div class="value" style="color: #10b981;">${report.byPriority.low}</div>
            </div>
        </div>
        <div class="content">
            <table>
                <thead>
                    <tr>
                        <th style="width: 60px;">Ref #</th>
                        <th style="width: 200px;">Item</th>
                        <th style="width: 25%;">Finding</th>
                        <th style="width: 25%;">Corrective Action</th>
                        <th style="width: 80px;">Priority</th>
                        <th style="width: 180px;">Pictures</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHTML}
                </tbody>
            </table>
        </div>
        ${generateFindingGalleryHTML(report, colors)}
        ${generateGoodGalleryHTML(report, colors)}
        ${generateCorrectiveGalleryHTML(report, colors)}
        <div class="footer">
            <button class="no-print" onclick="window.print()" style="padding: 10px 20px; background: ${colors.border}; color: white; border: none; border-radius: 6px; cursor: pointer;">üñ®Ô∏è Print Report</button>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;" onclick="this.style.display='none'">
        <span style="position: absolute; top: 20px; right: 40px; color: white; font-size: 40px; font-weight: bold; cursor: pointer;">&times;</span>
        <img id="modalImage" style="max-width: 90%; max-height: 90%; object-fit: contain;" />
    </div>

    <scr` + `ipt>
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'flex';
        }
        function scrollToRef(refId) {
            const element = document.getElementById('ref-' + refId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.backgroundColor = '#fef3c7';
                setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
            }
        }
    </scr` + `ipt>
</body>
</html>
            `;
        }

        // Generate Finding Picture Gallery HTML for department reports
        function generateFindingGalleryHTML(report, colors) {
            // Collect only finding pictures (not corrective)
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Finding type pictures
                    const findingPics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'finding'
                    );
                    
                    for (const pic of findingPics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            finding: item.finding,
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #fef3c7; border-bottom: 1px solid #fcd34d;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #dc2626; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #f5f5f5; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Finding ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
                    <h2 style="color: #92400e; margin-bottom: 10px;">üì∏ Finding Picture Gallery (${allPictures.length})</h2>
                    <p style="color: #78350f; font-size: 0.9rem; margin-bottom: 20px;">All finding pictures collected for easy reference. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }

        // Generate Good Observation Picture Gallery HTML for department reports
        function generateGoodGalleryHTML(report, colors) {
            // Collect only good observation pictures
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Good type pictures
                    const goodPics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'good'
                    );
                    
                    for (const pic of goodPics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            comment: item.comment || '',
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #a7f3d0;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #d1fae5; border-bottom: 1px solid #6ee7b7;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #059669; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #f0fdf4; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Good Observation ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #d1fae5; border: 2px solid #10b981; border-radius: 12px;">
                    <h2 style="color: #065f46; margin-bottom: 10px;">‚úÖ Good Observation Gallery (${allPictures.length})</h2>
                    <p style="color: #047857; font-size: 0.9rem; margin-bottom: 20px;">All good observation pictures collected for easy reference. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }

        // Generate Corrective Action Picture Gallery HTML for department reports
        function generateCorrectiveGalleryHTML(report, colors) {
            // Collect only corrective pictures
            const allPictures = [];
            for (const item of report.items) {
                if (item.pictures && item.pictures.length > 0) {
                    // Get only Corrective type pictures
                    const correctivePics = item.pictures.filter(p => 
                        p.pictureType && p.pictureType.toLowerCase() === 'corrective'
                    );
                    
                    for (const pic of correctivePics) {
                        allPictures.push({
                            referenceValue: item.referenceValue,
                            section: item.section,
                            title: item.title,
                            priority: item.priority,
                            finding: item.finding,
                            correctiveAction: item.correctiveAction,
                            base64: pic.base64,
                            contentType: pic.contentType,
                            fileName: pic.fileName,
                            pictureType: pic.pictureType
                        });
                    }
                }
            }
            
            if (allPictures.length === 0) {
                return '';
            }
            
            // Sort by reference value
            allPictures.sort((a, b) => {
                const refA = a.referenceValue || '';
                const refB = b.referenceValue || '';
                return refA.localeCompare(refB, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            const priorityColors = {
                'High': { bg: '#fee2e2', text: '#991b1b' },
                'Medium': { bg: '#fef3c7', text: '#92400e' },
                'Low': { bg: '#d1fae5', text: '#065f46' }
            };
            
            const pictureCards = allPictures.map((pic, index) => {
                return `
                    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #93c5fd;">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 10px 15px; background: #dbeafe; border-bottom: 1px solid #60a5fa;">
                            <a href="#ref-${pic.referenceValue.replace(/\./g, '-')}" onclick="scrollToRef('${pic.referenceValue.replace(/\./g, '-')}'); return false;" style="background: #2563eb; color: white; font-weight: bold; font-size: 1rem; padding: 5px 12px; border-radius: 20px; text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">#${pic.referenceValue}</a>
                        </div>
                        <div style="width: 100%; text-align: center; background: #eff6ff; padding: 10px;">
                            <img src="data:${pic.contentType};base64,${pic.base64}" 
                                 alt="Corrective Action ${pic.referenceValue}" 
                                 onclick="openImageModal(this.src)"
                                 style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" 
                                 onmouseover="this.style.transform='scale(1.02)'" 
                                 onmouseout="this.style.transform='scale(1)'" />
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="margin: 30px; padding: 20px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 12px;">
                    <h2 style="color: #1e40af; margin-bottom: 10px;">üîß Corrective Action Gallery (${allPictures.length})</h2>
                    <p style="color: #1d4ed8; font-size: 0.9rem; margin-bottom: 20px;">All corrective action pictures showing fixes applied. Click on any image to enlarge.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pictureCards}
                    </div>
                </div>
            `;
        }

        function continueAudit(auditId) {
            window.location.href = `/auditor/fill-audit?id=${auditId}`;
        }

        async function deleteAudit(auditId) {
            if (!confirm('Are you sure you want to delete this audit? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/audits/${auditId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete audit');

                await loadAudits();
            } catch (error) {
                console.error('Error deleting audit:', error);
                alert('Failed to delete audit: ' + error.message);
            }
        }
    </script>
</body>
</html>
