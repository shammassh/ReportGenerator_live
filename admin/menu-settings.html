<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Settings - Food Safety Audit System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #333;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .page-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .page-header p {
            opacity: 0.9;
            font-size: 15px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            margin-bottom: 15px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .info-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 20px 25px;
            margin-bottom: 30px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .info-banner-icon {
            font-size: 32px;
        }

        .info-banner-content h3 {
            color: #92400e;
            margin-bottom: 5px;
        }

        .info-banner-content p {
            color: #a16207;
            font-size: 14px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-card .label {
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }

        .filter-bar {
            background: white;
            border-radius: 16px;
            padding: 20px 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            min-width: 180px;
            transition: all 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .btn-filter {
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }

        .btn-filter:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .category-section {
            background: white;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .category-section.collapsed .menu-items {
            display: none;
        }

        .category-section.hidden {
            display: none;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .collapse-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .category-header {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f3f4f6;
        }

        .category-header h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-header.audit-ops { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .category-header.audit-ops h2 { color: #1e40af; }

        .category-header.reports { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); }
        .category-header.reports h2 { color: #5b21b6; }

        .category-header.admin { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }
        .category-header.admin h2 { color: #065f46; }

        .category-header.developer { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
        .category-header.developer h2 { color: #991b1b; }

        .category-header.report-actions { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .category-header.report-actions h2 { color: #92400e; }

        .category-header.audit-list { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); }
        .category-header.audit-list h2 { color: #3730a3; }

        .category-header.action-plan { background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%); }
        .category-header.action-plan h2 { color: #0f766e; }

        .category-header.dept-report { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
        .category-header.dept-report h2 { color: #9d174d; }

        .category-header.template-builder { background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); }
        .category-header.template-builder h2 { color: #c2410c; }

        .category-header.category-mgmt { background: linear-gradient(135deg, #d9f99d 0%, #bef264 100%); }
        .category-header.category-mgmt h2 { color: #4d7c0f; }

        .category-header.store-mgmt { background: linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%); }
        .category-header.store-mgmt h2 { color: #0e7490; }

        .category-header.brand-mgmt { background: linear-gradient(135deg, #fae8ff 0%, #f5d0fe 100%); }
        .category-header.brand-mgmt h2 { color: #a21caf; }

        .category-header.system-settings { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); }
        .category-header.system-settings h2 { color: #475569; }

        .menu-items {
            padding: 0;
        }

        .menu-item {
            display: grid;
            grid-template-columns: 50px 50px 50px 1fr 180px auto 80px;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s;
            gap: 15px;
        }

        .menu-item:hover {
            background: #f9fafb;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item-icon {
            font-size: 24px;
            text-align: center;
        }

        .menu-item-info h3 {
            font-size: 15px;
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .menu-item-info p {
            font-size: 12px;
            color: #6b7280;
        }

        .menu-item-url {
            font-size: 12px;
            color: #6b7280;
            font-family: monospace;
            background: #f3f4f6;
            padding: 5px 10px;
            border-radius: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .role-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .role-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .role-badge.active {
            background: #dcfce7;
            color: #166534;
            border-color: #22c55e;
        }

        .role-badge.inactive {
            background: #f3f4f6;
            color: #9ca3af;
            border-color: #e5e7eb;
        }

        .role-badge:hover {
            transform: scale(1.05);
        }

        /* Responsive design */
        @media (max-width: 1400px) {
            .menu-item {
                grid-template-columns: 45px 45px 45px minmax(150px, 1fr) minmax(100px, 150px) auto 70px;
                gap: 10px;
                padding: 12px 15px;
            }
            
            .menu-item-url {
                max-width: 120px;
            }
        }
        
        @media (max-width: 1100px) {
            .menu-item {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 18px 20px;
            }
            
            .order-controls {
                position: absolute;
                right: 80px;
                top: 50%;
                transform: translateY(-50%);
            }
            
            .menu-item {
                position: relative;
            }
            
            .sort-order-display {
                position: absolute;
                left: 15px;
                top: 18px;
            }
            
            .menu-item-icon {
                position: absolute;
                left: 55px;
                top: 18px;
            }
            
            .menu-item-info {
                padding-left: 60px;
            }
            
            .menu-item-url {
                max-width: 100%;
            }
            
            .toggle-switch {
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
            }
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 32px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .order-controls {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .order-btn {
            width: 26px;
            height: 26px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #6b7280;
            transition: all 0.2s;
        }

        .order-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .order-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .sort-order-display {
            font-size: 13px;
            color: #6b7280;
            text-align: center;
            font-weight: 600;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: 0.3s;
            border-radius: 32px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(28px);
        }

        .actions-bar {
            background: white;
            border-radius: 16px;
            padding: 20px 25px;
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .actions-bar .status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7280;
        }

        .actions-bar .buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .preview-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .preview-section h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-role-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 15px;
        }

        .preview-role-tab {
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            background: #f3f4f6;
            color: #6b7280;
        }

        .preview-role-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .preview-dashboard {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 25px;
            border: 2px dashed #e5e7eb;
        }

        .preview-category {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .preview-category h4 {
            font-size: 12px;
            text-transform: uppercase;
            color: #6b7280;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f3f4f6;
        }

        .preview-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .preview-button {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            display: none;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="page-header">
        <a href="/dashboard" class="back-btn">‚Üê Back to Dashboard</a>
        <h1>‚öôÔ∏è Menu Settings</h1>
        <p>Configure dashboard buttons and role-based visibility</p>
    </div>

    <div class="container">
        <!-- Info Banner -->
        <div class="info-banner">
            <div class="info-banner-icon">‚ÑπÔ∏è</div>
            <div class="info-banner-content">
                <h3>Preview Mode</h3>
                <p>This page shows how the dynamic menu system will work. Currently, the dashboard uses hardcoded permissions. 
                Changes saved here will be stored in the database and can be activated later without code changes.</p>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="number" id="totalButtons">15</div>
                <div class="label">Total Buttons</div>
            </div>
            <div class="stat-card">
                <div class="number" id="enabledButtons">15</div>
                <div class="label">Enabled</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalCategories">4</div>
                <div class="label">Categories</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalRoles">6</div>
                <div class="label">Roles</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>üîç Search</label>
                <input type="text" id="searchFilter" placeholder="Search buttons..." oninput="applyFilters()">
            </div>
            <div class="filter-group">
                <label>üìÇ Category</label>
                <select id="categoryFilter" onchange="applyFilters()">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="filter-group">
                <label>‚úÖ Status</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="enabled">Enabled Only</option>
                    <option value="disabled">Disabled Only</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn-filter" onclick="collapseAll()">‚ûñ Collapse All</button>
                <button class="btn-filter" onclick="expandAll()">‚ûï Expand All</button>
                <button class="btn-filter" onclick="clearFilters()">üîÑ Clear Filters</button>
            </div>
        </div>

        <!-- Categories -->
        <div id="categoriesContainer">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Actions Bar -->
        <div class="actions-bar">
            <div class="status">
                <span id="lastSaved">Last saved: Never</span>
            </div>
            <div class="buttons">
                <button class="btn btn-secondary" onclick="resetToDefaults()">üîÑ Reset to Defaults</button>
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Changes</button>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section">
            <h2>üëÅÔ∏è Live Preview - See what each role sees</h2>
            <div class="preview-role-tabs">
                <div class="preview-role-tab active" onclick="previewRole('Admin')">Admin</div>
                <div class="preview-role-tab" onclick="previewRole('SuperAuditor')">SuperAuditor</div>
                <div class="preview-role-tab" onclick="previewRole('Auditor')">Auditor</div>
                <div class="preview-role-tab" onclick="previewRole('StoreManager')">StoreManager</div>
                <div class="preview-role-tab" onclick="previewRole('AreaManager')">AreaManager</div>
                <div class="preview-role-tab" onclick="previewRole('HeadOfOperations')">HeadOfOperations</div>
            </div>
            <div class="preview-dashboard" id="previewDashboard">
                <!-- Preview will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        let menuData = [];
        let currentPreviewRole = 'Admin';
        let allRoles = []; // Will be loaded from database

        // Icon mapping - database stores code, we display emoji
        const iconMap = {
            'clipboard': 'üìã',
            'play': '‚ñ∂Ô∏è',
            'calendar': 'üìÖ',
            'calculator': 'üßÆ',
            'chart': 'üìä',
            'search': 'üîç',
            'gear': '‚öôÔ∏è',
            'file': 'üìÑ',
            'bell': 'üîî',
            'megaphone': 'üì¢',
            'envelope': '‚úâÔ∏è',
            'users': 'üë•',
            'store': 'üè™',
            'tag': 'üè∑Ô∏è',
            'template': 'üìù',
            'settings': '‚öôÔ∏è',
            'printer': 'üñ®Ô∏è',
            'close': '‚ùå',
            'check': '‚úÖ',
            'publish': 'üì§',
            'unpublish': 'üì•',
            'eye': 'üëÅÔ∏è',
            'building': 'üè¢',
            'document': 'üìÉ',
            'save': 'üíæ',
            'send': 'üì®',
            'plus': '‚ûï',
            'folder': 'üìÇ',
            'back': '‚¨ÖÔ∏è',
            'list': 'üìã',
            'build': 'üî®',
            'download': 'üì•',
            'upload': 'üì§',
            'trash': 'üóëÔ∏è',
            'edit': '‚úèÔ∏è',
            'image': 'üñºÔ∏è'
        };
        
        function getIcon(iconCode) {
            return iconMap[iconCode] || iconCode || 'üìå';
        }

        const categoryConfig = {
            'Audit Operations': { class: 'audit-ops', icon: 'üîç' },
            'Reports & Communications': { class: 'reports', icon: 'üìÑ' },
            'System Administration': { class: 'admin', icon: '‚öôÔ∏è' },
            'Developer Tools': { class: 'developer', icon: 'üîß' },
            'Report Actions': { class: 'report-actions', icon: 'üìã' },
            'Audit List Actions': { class: 'audit-list', icon: 'üìë' },
            'Action Plan Actions': { class: 'action-plan', icon: 'üìù' },
            'Department Report Actions': { class: 'dept-report', icon: 'üè¢' },
            'Template Builder Actions': { class: 'template-builder', icon: 'üî®' },
            'Category Management Actions': { class: 'category-mgmt', icon: 'üìÇ' },
            'Store Management Actions': { class: 'store-mgmt', icon: 'üè™' },
            'Brand Management Actions': { class: 'brand-mgmt', icon: 'üè∑Ô∏è' },
            'System Settings Actions': { class: 'system-settings', icon: '‚öôÔ∏è' }
        };

        // Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadRoles(); // Load roles first
            loadMenuSettings();
        });

        async function loadRoles() {
            try {
                const response = await fetch('/api/roles');
                const data = await response.json();
                if (data.success && data.roles) {
                    allRoles = data.roles.map(r => r.RoleName);
                    console.log('‚úÖ Loaded roles from database:', allRoles);
                } else {
                    // Fallback to defaults
                    allRoles = ['Admin', 'SuperAuditor', 'Auditor', 'StoreManager'];
                    console.warn('‚ö†Ô∏è Using fallback roles');
                }
            } catch (error) {
                console.error('Error loading roles:', error);
                allRoles = ['Admin', 'SuperAuditor', 'Auditor', 'StoreManager'];
            }
        }

        async function loadMenuSettings() {
            showLoading(true);
            try {
                const response = await fetch('/api/menu/settings');
                const data = await response.json();
                
                if (data.success) {
                    menuData = data.data;
                    populateCategoryFilter();
                    renderCategories();
                    updateStats();
                    previewRole(currentPreviewRole);
                } else {
                    showToast('Error loading settings', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading settings', 'error');
            }
            showLoading(false);
        }

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            const categories = [...new Set(menuData.map(m => m.Category))];
            
            container.innerHTML = categories.map(category => {
                const config = categoryConfig[category] || { class: '', icon: 'üìå' };
                const items = menuData.filter(m => m.Category === category).sort((a, b) => (a.SortOrder || 0) - (b.SortOrder || 0));
                
                return `
                    <div class="category-section" data-category="${category}" id="cat-${category.replace(/[^a-zA-Z0-9]/g, '')}">
                        <div class="category-header ${config.class}">
                            <h2>${config.icon} ${category}</h2>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span>${items.length} buttons</span>
                                <button class="collapse-btn" onclick="toggleCategory(this)" title="Collapse/Expand">‚ñº</button>
                            </div>
                        </div>
                        <div class="menu-items">
                            ${items.map((item, index) => renderMenuItem(item, index, items)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            applyFilters();
        }

        function renderMenuItem(item, index, categoryItems) {
            const roles = item.AllowedRoles ? item.AllowedRoles.split(',') : [];
            const isFirst = index === 0;
            const isLast = index === categoryItems.length - 1;
            
            return `
                <div class="menu-item" data-id="${item.MenuID}">
                    <div class="order-controls">
                        <button class="order-btn" ${isFirst ? 'disabled' : ''} onclick="moveItem(${item.MenuID}, 'up')" title="Move up">&uarr;</button>
                        <button class="order-btn" ${isLast ? 'disabled' : ''} onclick="moveItem(${item.MenuID}, 'down')" title="Move down">&darr;</button>
                    </div>
                    <div class="sort-order-display">#${item.SortOrder || index + 1}</div>
                    <div class="menu-item-icon">${getIcon(item.Icon)}</div>
                    <div class="menu-item-info">
                        <h3>${item.ButtonName}</h3>
                        <p>ID: ${item.ButtonID}</p>
                    </div>
                    <div class="menu-item-url">${item.Url || '-'}</div>
                    <div class="role-badges">
                        ${allRoles.map(role => `
                            <span class="role-badge ${roles.includes(role) ? 'active' : 'inactive'}" 
                                  onclick="toggleRole(${item.MenuID}, '${role}')">
                                ${role}
                            </span>
                        `).join('')}
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" ${item.IsEnabled ? 'checked' : ''} 
                               onchange="toggleEnabled(${item.MenuID}, this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;
        }

        function toggleRole(menuId, role) {
            const item = menuData.find(m => m.MenuID === menuId);
            if (!item) return;
            
            let roles = item.AllowedRoles ? item.AllowedRoles.split(',') : [];
            
            if (roles.includes(role)) {
                roles = roles.filter(r => r !== role);
            } else {
                roles.push(role);
            }
            
            item.AllowedRoles = roles.join(',');
            renderCategories();
            previewRole(currentPreviewRole);
        }

        function toggleEnabled(menuId, enabled) {
            const item = menuData.find(m => m.MenuID === menuId);
            if (item) {
                item.IsEnabled = enabled;
                updateStats();
                previewRole(currentPreviewRole);
            }
        }

        function moveItem(menuId, direction) {
            const item = menuData.find(m => m.MenuID === menuId);
            if (!item) return;
            
            // Get items in same category, sorted by SortOrder
            const categoryItems = menuData
                .filter(m => m.Category === item.Category)
                .sort((a, b) => (a.SortOrder || 0) - (b.SortOrder || 0));
            
            const currentIndex = categoryItems.findIndex(m => m.MenuID === menuId);
            const swapIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            
            if (swapIndex < 0 || swapIndex >= categoryItems.length) return;
            
            // Swap sort orders
            const currentOrder = item.SortOrder || currentIndex + 1;
            const swapItem = categoryItems[swapIndex];
            const swapOrder = swapItem.SortOrder || swapIndex + 1;
            
            item.SortOrder = swapOrder;
            swapItem.SortOrder = currentOrder;
            
            // Re-render
            renderCategories();
            previewRole(currentPreviewRole);
        }

        function updateStats() {
            const enabled = menuData.filter(m => m.IsEnabled).length;
            document.getElementById('totalButtons').textContent = menuData.length;
            document.getElementById('enabledButtons').textContent = enabled;
            document.getElementById('totalCategories').textContent = 
                [...new Set(menuData.map(m => m.Category))].length;
        }

        function previewRole(role) {
            currentPreviewRole = role;
            
            // Update active tab
            document.querySelectorAll('.preview-role-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent === role);
            });
            
            // Filter buttons for this role
            const visibleButtons = menuData.filter(m => 
                m.IsEnabled && m.AllowedRoles && m.AllowedRoles.split(',').includes(role)
            );
            
            if (visibleButtons.length === 0) {
                document.getElementById('previewDashboard').innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">üö´</div>
                        <p>No buttons visible for this role</p>
                    </div>
                `;
                return;
            }
            
            // Group by category
            const categories = {};
            visibleButtons.forEach(btn => {
                if (!categories[btn.Category]) {
                    categories[btn.Category] = [];
                }
                categories[btn.Category].push(btn);
            });
            
            // Sort buttons within each category by SortOrder
            Object.keys(categories).forEach(cat => {
                categories[cat].sort((a, b) => (a.SortOrder || 0) - (b.SortOrder || 0));
            });
            
            document.getElementById('previewDashboard').innerHTML = Object.entries(categories).map(([cat, buttons]) => {
                const config = categoryConfig[cat] || { icon: 'üìå' };
                return `
                    <div class="preview-category">
                        <h4>${config.icon} ${cat}</h4>
                        <div class="preview-buttons">
                            ${buttons.map(b => `
                                <div class="preview-button">
                                    <span>${getIcon(b.Icon)}</span>
                                    <span>${b.ButtonName}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function saveSettings() {
            showLoading(true);
            try {
                const response = await fetch('/api/menu/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: menuData })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('‚úÖ Settings saved successfully!', 'success');
                    document.getElementById('lastSaved').textContent = 
                        'Last saved: ' + new Date().toLocaleString();
                } else {
                    showToast('Error saving settings: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error saving settings', 'error');
            }
            showLoading(false);
        }

        async function resetToDefaults() {
            if (!confirm('Reset all permissions to defaults? This cannot be undone.')) {
                return;
            }
            
            showLoading(true);
            try {
                const response = await fetch('/api/menu/settings/reset', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    await loadMenuSettings();
                    showToast('‚úÖ Reset to defaults', 'success');
                }
            } catch (error) {
                showToast('Error resetting', 'error');
            }
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==========================================
        // Filter Functions
        // ==========================================

        function populateCategoryFilter() {
            const categories = [...new Set(menuData.map(m => m.Category))];
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">All Categories</option>' + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const sections = document.querySelectorAll('.category-section');
            
            sections.forEach(section => {
                const category = section.dataset.category;
                const items = section.querySelectorAll('.menu-item');
                let visibleItems = 0;

                // Filter by category
                if (categoryFilter && category !== categoryFilter) {
                    section.classList.add('hidden');
                    return;
                }

                // Filter individual items
                items.forEach(item => {
                    const menuId = parseInt(item.dataset.id);
                    const menuItem = menuData.find(m => m.MenuID === menuId);
                    if (!menuItem) return;

                    let visible = true;

                    // Search filter
                    if (searchTerm) {
                        const matchesSearch = 
                            menuItem.ButtonName.toLowerCase().includes(searchTerm) ||
                            menuItem.ButtonID.toLowerCase().includes(searchTerm);
                        if (!matchesSearch) visible = false;
                    }

                    // Status filter
                    if (statusFilter === 'enabled' && !menuItem.IsEnabled) visible = false;
                    if (statusFilter === 'disabled' && menuItem.IsEnabled) visible = false;

                    item.style.display = visible ? 'grid' : 'none';
                    if (visible) visibleItems++;
                });

                // Hide section if no visible items
                section.classList.toggle('hidden', visibleItems === 0);
            });
        }

        function clearFilters() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            applyFilters();
        }

        function toggleCategory(btn) {
            const section = btn.closest('.category-section');
            section.classList.toggle('collapsed');
            btn.textContent = section.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        }

        function collapseAll() {
            document.querySelectorAll('.category-section').forEach(section => {
                section.classList.add('collapsed');
                const btn = section.querySelector('.collapse-btn');
                if (btn) btn.textContent = '‚ñ∂';
            });
        }

        function expandAll() {
            document.querySelectorAll('.category-section').forEach(section => {
                section.classList.remove('collapsed');
                const btn = section.querySelector('.collapse-btn');
                if (btn) btn.textContent = '‚ñº';
            });
        }
    </script>
</body>
</html>
